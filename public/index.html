<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Integrity - Stellaris FB</title>
    <link rel="icon" href="https://img1.wsimg.com/isteam/ip/2c5f94ee-4964-4e9b-9b9c-a55121f8611b/favicon/31eb51a1-8979-4194-bfa2-e4b30ee1178d/2437d5de-854d-40b2-86b2-fd879f3469f0.png/:/rs=w:64,h:64,m?v=3" type="image/png">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&family=Libre+Baskerville:wght@400;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="/styles.css?v=33">
  </head>
  <body>
    <div class="app-header">
      <div class="logo-container">
        <img class="logo-light" src="https://img1.wsimg.com/isteam/ip/2c5f94ee-4964-4e9b-9b9c-a55121f8611b/WEB_Stellaris_Primary%20Logo_Horizontal_Full%20Col.png/:/rs=w:400,h:130,cg:true,m/cr=w:400,h:130/qt=q:95" alt="Stellaris">
        <img class="logo-dark" src="https://img1.wsimg.com/isteam/ip/2c5f94ee-4964-4e9b-9b9c-a55121f8611b/WEB_Stellaris_Primary%20Logo_Horizontal_Reversed.png/:/rs=w:309,h:100,cg:true,m/cr=w:309,h:100/qt=q:26" alt="Stellaris">
      </div>
      <div class="header-title" onclick="goHome()" style="cursor:pointer;" title="Go to home screen">INTEGRITY</div>
      <div class="header-search-wrapper">
        <input type="text" id="searchInput" class="header-search" placeholder="Search Contacts..." onkeyup="handleSearch(event)" onkeydown="handleSearchKeydown(event)" onfocus="showSearchDropdown()" autocomplete="off">
        <div id="searchDropdown" class="search-dropdown">
          <div class="status-toggle-row">
            <button type="button" class="status-toggle-btn active" data-status="Active" onclick="setContactStatusFilter('Active')">Active</button>
            <button type="button" class="status-toggle-btn" data-status="Inactive" onclick="setContactStatusFilter('Inactive')">Inactive</button>
            <button type="button" class="status-toggle-btn" data-status="All" onclick="setContactStatusFilter('All')">All</button>
          </div>
          <div id="searchStatus" style="font-size:11px; color:#666; height:14px; margin-bottom:2px; text-align:right;"></div>
          <div id="loading">Loading directory...</div>
          <ul id="contactList"></ul>
        </div>
      </div>
      <div class="user-indicator">
        <button class="header-icon-btn" onclick="openMarketingModal()" title="Marketing">üì£</button>
        <button class="shortcuts-help" onclick="showShortcutsHelp()" title="Keyboard shortcuts">?</button>
        <button class="settings-cog" onclick="openGlobalSettings()" title="Settings">‚öô</button>
        <button class="theme-toggle" onclick="toggleDarkMode()" title="Toggle dark mode">‚óê</button>
        <span class="user-email" id="userEmail">Loading...</span>
      </div>
    </div>

    <div class="container">

      <div class="column form-section layout-stack-y gap-md">
        <!-- Header Zone: Dossier Style -->
        <div id="profileHeaderZone" class="layout-stack-y gap-sm">
          <div class="breadcrumb-row layout-stack-x" style="justify-content:space-between; width:100%; margin-bottom:8px;">
            <div id="breadcrumb-bar"></div>
            <button type="button" class="new-contact-btn" onclick="resetForm()" style="margin-left:auto;">+ NEW CONTACT</button>
          </div>
          <div class="dossier-header">
            <!-- Left Block: Breadcrumb + Name + Badge -->
            <div class="dossier-left layout-stack-y gap-xs">
              <div class="layout-stack-x gap-xs">
                <h2 id="formTitle">Contact</h2>
                <span id="refreshBtn" class="refresh-icon" onclick="refreshCurrentContact()" title="Refresh Record">‚Üª</span>
                <span id="deceasedBadge" class="deceased-badge" style="display:none;">DECEASED</span>
              </div>
              <div id="formSubtitle" class="form-subtitle"></div>
              <div id="contactQuickInfo" class="dossier-meta" style="text-align:left;"></div>
              <button type="button" id="contactBackBtn" class="contact-back-btn" onclick="goBackToContact()" style="display:none;">‚Üê Back</button>
            </div>
            <!-- Right Block: Status & Metadata -->
            <div class="dossier-right layout-stack-y gap-xs">
              <div class="dossier-badges layout-stack-x gap-xs">
                <span id="statusBadge" class="status-badge status-active clickable-badge" style="display:none;" onclick="toggleContactStatus()" title="Click to toggle status">Active</span>
                <span id="marketingBadge" class="marketing-badge clickable-badge" style="display:none;" onclick="openUnsubscribeEdit()" title="Click to edit marketing preferences"></span>
                <div class="actions-menu-wrapper" id="actionsMenuWrapper" style="display:none;">
                  <button type="button" class="actions-menu-btn" onclick="toggleActionsMenu()">Actions</button>
                  <div class="actions-dropdown" id="actionsDropdown">
                    <button type="button" onclick="markAsDeceased()">Mark as Deceased</button>
                    <button type="button" id="undoDeceasedBtn" onclick="undoDeceased()" style="display:none;">Undo Deceased Status</button>
                    <button type="button" id="addDuplicateWarningBtn" onclick="openAddDuplicateWarning()">Add Duplicate Warning</button>
                    <button type="button" id="deleteDuplicateWarningBtn" onclick="confirmDeleteDuplicateWarning()" style="display:none;">Delete Duplicate Warning</button>
                  </div>
                </div>
              </div>
              <div id="dossierMeta" class="dossier-meta"></div>
            </div>
          </div>
        </div>

        <!-- Content Zone -->
        <div id="emptyState">
           <img src="https://img1.wsimg.com/isteam/ip/2c5f94ee-4964-4e9b-9b9c-a55121f8611b/favicon/31eb51a1-8979-4194-bfa2-e4b30ee1178d/2437d5de-854d-40b2-86b2-fd879f3469f0.png/:/rs=w:128,h:128,m" style="height:64px; width:64px; margin-bottom:15px; opacity:0.8;">
           Search for a contact or click '+ New Contact' to begin.
        </div>

        <div id="profileContent" style="display:none; flex:1; flex-direction:column;">
          <form id="contactForm" onsubmit="handleFormSubmit(this); return false;" style="display:flex; flex-direction:column; flex:1;">
            <input type="hidden" name="recordId" id="recordId">
            <div class="profile-columns" id="profileColumns">
              <div class="profile-col profile-col-left">
                <details id="mobile-facts-accordion" open>
                  <summary class="mobile-only-summary">Contact Details</summary>
                <span id="editBtn" style="display:none;"></span>
                
                <!-- Duplicate Warning Box (left column) -->
                <div id="duplicateWarningBox" class="duplicate-warning-box">
                  <div class="warning-content">
                    <span class="warning-icon">‚ö†Ô∏è</span>
                    <span id="duplicateWarningText"></span>
                  </div>
                  <div class="warning-actions">
                    <a class="warning-link" onclick="openEditDuplicateWarning()">EDIT</a>
                    <a class="warning-link" onclick="hideDuplicateWarning()">HIDE</a>
                  </div>
                </div>
                
                <div class="collapsible-section" id="nameSection">
                  <div class="collapsible-header" onclick="toggleCollapsible('nameSection')">
                    <span class="collapsible-icon">&#9654;</span>
                    <span class="collapsible-title">Name</span>
                  </div>
                  <div class="collapsible-content">
                    <div class="form-row-3">
                      <div class="field-group"><label>First Name</label><input type="text" name="firstName" id="firstName" class="locked" readonly required></div>
                      <div class="field-group"><label>Middle Name</label><input type="text" name="middleName" id="middleName" class="locked" readonly></div>
                      <div class="field-group"><label>Last Name</label><input type="text" name="lastName" id="lastName" class="locked" readonly required></div>
                    </div>
                    <div class="form-row-2">
                      <div class="field-group"><label>Prefers to be called</label><input type="text" name="preferredName" id="preferredName" class="locked" readonly></div>
                      <div class="field-group"><label>Doesn't like to be called</label><input type="text" name="doesNotLike" id="doesNotLike" class="locked" readonly></div>
                    </div>
                    <div class="form-row-2">
                      <div class="field-group"><label>Mother's Maiden Name</label><input type="text" name="mothersMaidenName" id="mothersMaidenName" class="locked" readonly></div>
                      <div class="field-group"><label>Previous Names</label><textarea name="previousNames" id="previousNames" class="locked" readonly rows="2" style="resize:vertical;"></textarea></div>
                    </div>
                  </div>
                </div>

                <div class="collapsible-section" id="contactInfoSection">
                  <div class="collapsible-header" onclick="toggleCollapsible('contactInfoSection')">
                    <span class="collapsible-icon">&#9654;</span>
                    <span class="collapsible-title">Contact Info</span>
                  </div>
                  <div class="collapsible-content">
                    <div class="field-group"><label>Mobile</label><input type="text" name="mobilePhone" id="mobilePhone" class="locked" readonly></div>
                    <div class="field-group field-with-note">
                      <label>Email</label>
                      <div class="input-with-note">
                        <input type="email" name="email1" id="email1" class="locked" readonly>
                        <button type="button" class="note-icon" data-note-field="email1Comment" onclick="openNotePopover(this, 'email1Comment')" title="Add/view note"></button>
                      </div>
                      <textarea name="email1Comment" id="email1Comment" class="note-hidden-field" rows="1"></textarea>
                    </div>
                    <div class="field-group field-with-note">
                      <label>Email 2</label>
                      <div class="input-with-note">
                        <input type="email" name="email2" id="email2" class="locked" readonly>
                        <button type="button" class="note-icon" data-note-field="email2Comment" onclick="openNotePopover(this, 'email2Comment')" title="Add/view note"></button>
                      </div>
                      <textarea name="email2Comment" id="email2Comment" class="note-hidden-field" rows="1"></textarea>
                    </div>
                    <div class="field-group field-with-note">
                      <label>Email 3</label>
                      <div class="input-with-note">
                        <input type="email" name="email3" id="email3" class="locked" readonly>
                        <button type="button" class="note-icon" data-note-field="email3Comment" onclick="openNotePopover(this, 'email3Comment')" title="Add/view note"></button>
                      </div>
                      <textarea name="email3Comment" id="email3Comment" class="note-hidden-field" rows="1"></textarea>
                    </div>
                  </div>
                </div>

                <div class="collapsible-section" id="personalSection">
                  <div class="collapsible-header" onclick="toggleCollapsible('personalSection')">
                    <span class="collapsible-icon">&#9654;</span>
                    <span class="collapsible-title">Personal Details</span>
                  </div>
                  <div class="collapsible-content">
                    <div class="form-row-2">
                      <div class="field-group"><label>Date of Birth</label><input type="text" name="dateOfBirth" id="dateOfBirth" class="locked" readonly placeholder="DD/MM/YYYY"></div>
                      <div class="field-group field-with-note">
                        <label>Gender</label>
                        <input type="hidden" name="genderOther" id="genderOther">
                        <div class="input-with-note select-with-note">
                          <select name="gender" id="gender" class="locked" disabled onchange="handleGenderChange()">
                            <option value=""></option>
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                            <option value="Prefer not to say">Prefer not to say</option>
                            <option value="Other (specify)">Other (specify)</option>
                          </select>
                        </div>
                      </div>
                    </div>
                    <div class="form-row-2">
                      <div class="field-group">
                        <label>Marital Status</label>
                        <select name="maritalStatus" id="maritalStatus" class="locked" disabled>
                          <option value=""></option>
                          <option value="Single">Single</option>
                          <option value="Married">Married</option>
                          <option value="De Facto">De Facto</option>
                        </select>
                      </div>
                      <div class="field-group"></div>
                    </div>
                  </div>
                </div>

                <div class="collapsible-section" id="notesSection">
                  <div class="collapsible-header" onclick="toggleCollapsible('notesSection')">
                    <span class="collapsible-icon">&#9654;</span>
                    <span class="collapsible-title">Notes</span>
                  </div>
                  <div class="collapsible-content">
                    <div class="field-group"><textarea name="notes" id="notes" class="locked" readonly></textarea></div>
                  </div>
                </div>

                <div class="collapsible-section" id="addressHistorySection">
                  <div class="collapsible-header" onclick="toggleCollapsible('addressHistorySection')" style="display:flex; justify-content:space-between; align-items:center;">
                    <div style="display:flex; align-items:center; gap:6px;">
                      <span class="collapsible-icon">&#9654;</span>
                      <span class="collapsible-title">Addresses</span>
                    </div>
                  </div>
                  <div class="collapsible-content">
                    <div id="postalAddressSection" class="postal-address-section">
                      <div class="address-section-header">
                        <span class="address-section-label">Postal Address</span>
                        <span id="postalAddressAddBtn" class="address-section-add" onclick="openPostalAddressModal()">+ Add</span>
                      </div>
                      <div id="postalAddressDisplay"></div>
                    </div>
                    <div class="address-section-header" style="margin-top:12px;">
                      <span class="address-section-label">Residential Address History</span>
                      <span class="address-section-add" onclick="openAddressModal(false)">+ Add</span>
                    </div>
                    <div id="addressHistoryList" class="address-history-list"></div>
                  </div>
                </div>

                <div class="collapsible-section" id="employmentHistorySection">
                  <div class="collapsible-header" onclick="toggleCollapsible('employmentHistorySection')" style="display:flex; justify-content:space-between; align-items:center;">
                    <div style="display:flex; align-items:center; gap:6px;">
                      <span class="collapsible-icon">&#9654;</span>
                      <span class="collapsible-title">Employment</span>
                    </div>
                  </div>
                  <div class="collapsible-content">
                    <div class="address-section-header">
                      <span class="address-section-label">Employment History</span>
                      <span class="address-section-add" onclick="openEmploymentModal()">+ Add</span>
                    </div>
                    <div id="employmentHistoryList" class="employment-history-list"></div>
                  </div>
                </div>

                <div id="deleteSection" style="margin-top:auto; padding-top:20px;">
                  <button type="button" class="btn-delete" onclick="confirmDeleteContact()">Delete Contact</button>
                </div>
                </details>
              </div>

              <div class="profile-col profile-col-center">
                <details id="mobile-relationships-accordion" open>
                  <summary class="mobile-only-summary">Relationships</summary>
                <div id="spouseSection" class="spouse-section-wrapper">
                  <div class="spouse-two-col-row">
                    <div class="spouse-left-col">
                      <span id="spouseBadge" class="connection-role-badge spouse">Spouse</span>
                      <span id="spouseStatusText" class="connection-name">Single</span>
                      <span id="spouseHistoryDate" class="connection-date"></span>
                    </div>
                    <span id="spouseHistoryToggle" class="spouse-history-toggle" onclick="toggleSpouseHistory()" style="display:none;">
                      <span id="spouseHistoryArrow" class="collapsible-icon">&#9654;</span>
                      <span class="collapsible-title">History</span>
                    </span>
                    <span id="spouseEditLink" class="spouse-action-link" onclick="openSpouseModal()">Edit</span>
                  </div>
                  <ul id="spouseHistoryList" class="spouse-history-list" style="display:none;"></ul>
                </div>
                <div id="connectionsSection" class="connections-section-scrollable">
                  <div id="connectionsAccordionWrapper" style="display:none;">
                    <div class="collapsible-header connections-accordion-header" onclick="toggleConnectionsAccordion()">
                      <span id="connectionsAccordionArrow" class="collapsible-icon expanded">&#9654;</span>
                      <span class="collapsible-title">Connections</span>
                      <span id="addConnectionLink" class="spouse-action-link" onclick="event.stopPropagation(); openAddConnectionModal()">+ Add</span>
                    </div>
                  </div>
                  <div id="connectionsNoAccordionAdd" class="connections-add-row" style="justify-content: space-between; align-items: center;">
                    <span class="collapsible-title" style="margin: 0;">Connections</span>
                    <span class="spouse-action-link" onclick="openAddConnectionModal()">+ Add</span>
                  </div>
                  <div id="connectionsContent" class="connections-two-col">
                    <ul id="connectionsListLeft" class="connections-list connections-col"></ul>
                    <ul id="connectionsListRight" class="connections-list connections-col"></ul>
                  </div>
                </div>
                </details>
                <div id="opportunitiesWrapper" class="mobile-orderable">
                  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <h2 style="font-size:15px; margin-bottom:0;">Opportunities <span id="oppSortBtn" class="sort-icon" onclick="toggleOppSort()">‚áÖ</span></h2>
                    <button type="button" class="quick-add-btn" onclick="quickAddOpportunity()" title="Add new opportunity">+ New Opportunity</button>
                  </div>
                  <div id="oppLoading" style="display:none;">Loading...</div>
                  <ul id="oppList" class="opp-list"></ul>
                </div>
              </div>

              <div class="profile-col profile-col-right">
                <div class="panel-box">
                  <h3 style="margin: 0 0 12px 0; font-size: 14px; color: var(--color-trail);">Marketing History</h3>
                  <div id="marketingTimeline">
                    <p class="mt-empty">No marketing history.</p>
                  </div>
                </div>
              </div>
            </div>
            <div id="actionRow" class="save-row" style="display:none;">
               <button type="button" id="cancelBtn" class="btn-cancel" onclick="cancelNewContact()" style="display:none;">Cancel</button>
               <button type="submit" id="submitBtn" style="width:auto; min-width:200px;">Create Contact</button>
            </div>
            <div id="status" style="text-align:center; margin-bottom:15px; min-height:18px;"></div>

          </form>
        </div>
      </div>


      <div id="oppDetailPanel" class="slide-panel">
        <div class="panel-header">
          <div style="display:flex; flex-direction:column; gap:5px;">
            <button id="panelBackBtn" class="back-btn" onclick="popHistory()">‚Üê Back</button>
            <h2 id="panelTitle" style="margin:0; border:none; font-size:16px;">Details</h2>
          </div>
          <button class="close-panel" onclick="closeOppPanel()">‚úï</button>
        </div>
        <div id="panelContent" class="panel-content">
          <div style="text-align:center; color:#999; margin-top:50px;">Loading...</div>
        </div>
      </div>

      <div id="oppComposer" class="slide-panel composer-panel">
        <div class="composer-header">
          <div class="composer-header-left">
            <h2 style="margin:0; font-size:18px; color:var(--color-midnight);">New Opportunity</h2>
            <p id="composerContactInfo" class="composer-contact-info"></p>
          </div>
          <button class="close-panel" onclick="closeOppComposer()">‚úï</button>
        </div>
        <div class="composer-body">
          <div class="composer-section">
            <div class="composer-section-title">Opportunity Details</div>
            <div class="composer-field">
              <label>Opportunity Name</label>
              <input type="text" id="composerOppName" placeholder="Enter opportunity name...">
            </div>
            <div class="composer-field">
              <label>Opportunity Type</label>
              <select id="composerOppType">
                <option value="Home Loans" selected>Home Loans</option>
                <option value="Commercial Loans">Commercial Loans</option>
                <option value="Deposit Bonds">Deposit Bonds</option>
                <option value="Insurance (General)">Insurance (General)</option>
                <option value="Insurance (Life)">Insurance (Life)</option>
                <option value="Personal Loans">Personal Loans</option>
                <option value="Asset Finance">Asset Finance</option>
                <option value="Tax Depreciation Schedule">Tax Depreciation Schedule</option>
                <option value="Financial Planning">Financial Planning</option>
              </select>
            </div>
          </div>
          <div class="composer-section">
            <div style="display:flex; flex-direction:column; gap:8px;">
              <div style="display:flex; align-items:center; gap:8px;">
                <span style="font-size:11px; color:#666; min-width:100px;">Primary Applicant:</span>
                <a id="composerPrimaryName" class="data-link" style="margin:0; padding:4px 8px; font-size:12px;"></a>
              </div>
              <div id="composerSpouseSection" style="display:none;">
                <label class="composer-checkbox-label">
                  <input type="checkbox" id="composerAddSpouse" onchange="updateComposerSpouseLabel()">
                  <span id="composerSpouseLabel"><span id="composerSpouseLabelPrefix">Also add </span><strong id="composerSpouseName"></strong><span id="composerSpouseLabelSuffix"> as Applicant</span></span>
                </label>
              </div>
            </div>
          </div>
          <div class="composer-section">
            <div class="composer-section-title" style="display:flex; justify-content:space-between; align-items:center;">
              <span>Import from Taco</span>
              <span style="font-size:11px; font-weight:normal; color:#999;">(optional)</span>
            </div>
            <div id="tacoImportArea">
              <textarea id="tacoRawInput" placeholder="Paste Taco data here..." rows="4" style="width:100%; font-size:13px; padding:10px; border:1px solid var(--color-border); border-radius:6px; resize:vertical; font-family:inherit;"></textarea>
              <button type="button" id="tacoParseBtnAction" onclick="parseTacoData()" style="margin-top:8px; padding:6px 14px; font-size:12px; background:var(--color-midnight); color:#FFF; border:none; border-radius:4px; cursor:pointer;">Parse</button>
            </div>
            <div id="tacoPreview" style="display:none; margin-top:10px;">
              <div style="font-size:12px; font-weight:500; margin-bottom:8px; color:var(--color-trail);">Parsed Fields:</div>
              <div id="tacoPreviewContent" style="font-size:12px; background:var(--color-salt); padding:10px; border-radius:6px; max-height:200px; overflow-y:auto;"></div>
              <button type="button" onclick="clearTacoImport()" style="margin-top:8px; padding:4px 10px; font-size:11px; background:transparent; color:#999; border:1px solid #CCC; border-radius:4px; cursor:pointer;">Clear Import</button>
            </div>
          </div>
        </div>
        <div class="composer-footer">
          <button type="button" class="composer-btn-cancel" onclick="closeOppComposer()">Cancel</button>
          <button type="button" class="composer-btn-create" onclick="submitFromComposer()">Create Opportunity</button>
        </div>
      </div>

      <div id="spouseModal" class="modal">
        <div class="modal-content">
          <div class="modal-sidebar">
             <img src="https://img1.wsimg.com/isteam/ip/2c5f94ee-4964-4e9b-9b9c-a55121f8611b/favicon/31eb51a1-8979-4194-bfa2-e4b30ee1178d/2437d5de-854d-40b2-86b2-fd879f3469f0.png/:/rs=w:64,h:64,m?v=3">
          </div>
          <div class="modal-body">

            <div id="connectForm" style="display:none; flex:1; flex-direction:column;">
               <h3 style="margin-top:0; margin-bottom:15px; font-size:16px;">Connect Spouse</h3>
               <p style="font-size:13px; margin-bottom:10px; color:#666;">Search for the contact to connect:</p>
               <input type="text" id="spouseSearchInput" placeholder="Start typing name..." onkeyup="handleSpouseSearch(event)" onfocus="loadRecentContactsForModal()">
               <div id="spouseSearchResults" class="search-dropdown"></div>
               <div style="margin-top:auto; display:flex; gap:10px; justify-content:flex-end;">
                  <button type="button" class="btn-cancel" onclick="closeSpouseModal()">Cancel</button>
               </div>
            </div>

            <div id="confirmConnectForm" style="display:none; flex-direction:column;">
               <h3 style="margin-top:0; margin-bottom:15px; font-size:16px;">Confirm Connection</h3>
               <p style="font-size:13px; color:#666; margin-bottom:20px;">Are you sure you want to set <strong id="targetSpouseName" style="color:var(--color-trail);"></strong> as the spouse?</p>
               <input type="hidden" id="targetSpouseId">
               <div style="margin-top:auto; display:flex; gap:10px; justify-content:flex-end;">
                  <button type="button" class="btn-cancel" onclick="backToSearch()">Back</button>
                  <button type="button" class="btn-confirm" onclick="executeSpouseChange('connect')">Confirm</button>
               </div>
            </div>

            <div id="disconnectForm" style="display:none; flex-direction:column;">
               <h3 style="margin-top:0; margin-bottom:15px; font-size:16px;">Disconnect Spouse</h3>
               <p style="font-size:13px; color:#666; margin-bottom:20px;">Are you sure you want to disconnect <strong id="currentSpouseName" style="color:var(--color-trail);"></strong>?</p>
               <input type="hidden" id="currentSpouseId">
               <div style="margin-top:auto; display:flex; gap:10px; justify-content:flex-end;">
                  <button type="button" class="btn-cancel" onclick="closeSpouseModal()">Cancel</button>
                  <button type="button" class="btn-danger" onclick="executeSpouseChange('disconnect')">Disconnect</button>
               </div>
            </div>

          </div>
        </div>
      </div>

      <!-- Add Connection Modal -->
      <div id="addConnectionModal" class="modal">
        <div class="modal-content" style="max-width:500px; min-height:400px;">
          <div class="modal-sidebar" style="background:var(--color-cedar);">
            <span style="font-size:28px;">üîó</span>
          </div>
          <div class="modal-body" style="display:flex; flex-direction:column;">
            
            <div id="connectionStep1" style="flex:1; display:flex; flex-direction:column;">
              <h3 style="margin-top:0; margin-bottom:15px; font-size:16px;">Add Connection</h3>
              <p style="font-size:13px; margin-bottom:10px; color:#666;">Search for a contact or select from recent:</p>
              <input type="text" id="connectionSearchInput" placeholder="Start typing name..." onkeyup="handleConnectionSearch(event)" onfocus="loadRecentContactsForConnectionModal()" style="margin-bottom:10px;">
              <div id="connectionSearchResults" class="search-dropdown"></div>
              <div style="margin-top:auto; display:flex; gap:10px; justify-content:flex-end; padding-top:15px;">
                <button type="button" class="btn-cancel" onclick="closeAddConnectionModal()">Cancel</button>
              </div>
            </div>

            <div id="connectionStep2" style="display:none; flex:1; flex-direction:column;">
              <h3 style="margin-top:0; margin-bottom:15px; font-size:16px;">Select Relationship</h3>
              <p style="font-size:13px; color:#666; margin-bottom:15px;">
                How is <strong id="currentContactNameConn" style="color:var(--color-trail);"></strong> related to <strong id="targetContactNameConn" style="color:var(--color-trail);"></strong>?
              </p>
              <input type="hidden" id="targetConnectionContactId">
              <select id="connectionRoleSelect" style="padding:10px; font-size:14px; border:1px solid #ddd; border-radius:4px; margin-bottom:20px;">
                <option value="">-- Select relationship --</option>
              </select>
              <div style="margin-top:auto; display:flex; gap:10px; justify-content:flex-end;">
                <button type="button" class="btn-cancel" onclick="backToConnectionStep1()">Back</button>
                <button type="button" class="btn-confirm" id="confirmConnectionBtn" onclick="executeCreateConnection()">Create Connection</button>
              </div>
            </div>

          </div>
        </div>
      </div>

      <!-- Contact Quick-View Card -->
      <div id="contactQuickView" class="contact-quick-view">
        <div class="quick-view-header">
          <div class="quick-view-avatar" id="quickViewAvatar"></div>
          <div class="quick-view-name-section">
            <div class="quick-view-name" id="quickViewName"></div>
            <div class="quick-view-preferred" id="quickViewPreferred"></div>
          </div>
        </div>
        <div class="quick-view-details" id="quickViewDetails"></div>
        <div class="quick-view-action">
          <button type="button" class="btn-view-profile" onclick="navigateFromQuickView(document.getElementById('contactQuickView').dataset.contactId)">View Full Profile <span class="arrow">‚Üí</span></button>
        </div>
        <div class="quick-view-footer" id="quickViewFooter"></div>
      </div>

      <!-- Deactivate Connection Confirm Modal -->
      <div id="deactivateConnectionModal" class="modal">
        <div class="modal-content" style="max-width:480px;">
          <div class="modal-sidebar" style="background:var(--color-midnight);">
            <span style="font-size:28px;">üîó</span>
          </div>
          <div class="modal-body">
            <h3 class="modal-title" style="margin-top:0; margin-bottom:15px; font-size:15px; line-height: 1.4;"></h3>
            <div class="modal-body-content" style="font-size:13px;">
            </div>
          </div>
        </div>
      </div>

      <div id="deleteConfirmModal" class="modal">
        <div class="modal-content" style="max-width:400px;">
          <div class="modal-sidebar" style="background:#A00;">
            <span style="font-size:28px;">‚ö†</span>
          </div>
          <div class="modal-body">
            <h3 style="margin-top:0; margin-bottom:15px; font-size:16px;">Delete Contact</h3>
            <p id="deleteConfirmMessage" style="font-size:13px; color:#666; margin-bottom:20px;"></p>
            <div style="display:flex; gap:10px; justify-content:flex-end;">
              <button type="button" class="btn-cancel" onclick="closeDeleteConfirmModal()">Cancel</button>
              <button type="button" class="btn-danger" onclick="executeDeleteContact()">Delete</button>
            </div>
          </div>
        </div>
      </div>

      <div id="unsubscribeModal" class="modal">
        <div class="modal-content" style="max-width:400px;">
          <div class="modal-sidebar" style="background:var(--color-midnight);">
            <span style="font-size:28px;">üìß</span>
          </div>
          <div class="modal-body">
            <h3 style="margin-top:0; margin-bottom:15px; font-size:16px;">Change Marketing Preferences</h3>
            <div style="margin-bottom:20px;">
              <label class="checkbox-label" style="display:flex; align-items:center; gap:10px; cursor:pointer;">
                <input type="checkbox" id="unsubscribeCheckbox" style="width:18px; height:18px;">
                <span>Unsubscribe from Marketing</span>
              </label>
            </div>
            <div style="display:flex; gap:10px; justify-content:flex-end;">
              <button type="button" class="btn-cancel" onclick="closeUnsubscribeModal()">Cancel</button>
              <button type="button" class="btn-primary" onclick="saveUnsubscribePreference()">Save</button>
            </div>
          </div>
        </div>
      </div>

      <div id="deleteOppConfirmModal" class="modal">
        <div class="modal-content" style="max-width:400px;">
          <div class="modal-sidebar" style="background:#A00;">
            <span style="font-size:28px;">‚ö†</span>
          </div>
          <div class="modal-body">
            <h3 style="margin-top:0; margin-bottom:15px; font-size:16px;">Delete Opportunity</h3>
            <p id="deleteOppConfirmMessage" style="font-size:13px; color:#666; margin-bottom:20px;"></p>
            <div style="display:flex; gap:10px; justify-content:flex-end;">
              <button type="button" class="btn-cancel" onclick="closeDeleteOppConfirmModal()">Cancel</button>
              <button type="button" class="btn-danger" onclick="executeDeleteOpportunity()">Delete</button>
            </div>
          </div>
        </div>
      </div>

      <div id="deceasedConfirmModal" class="modal">
        <div class="modal-content" style="max-width:440px;">
          <div class="modal-sidebar" style="background:#666;">
            <span style="font-size:20px; font-weight:600; color:#FFF;">RIP</span>
          </div>
          <div class="modal-body">
            <h3 id="deceasedModalTitle" style="margin-top:0; margin-bottom:15px; font-size:16px;">Mark as Deceased</h3>
            <p id="deceasedConfirmMessage" style="font-size:13px; color:#666; margin-bottom:20px;"></p>
            <div style="display:flex; gap:10px; justify-content:flex-end;">
              <button type="button" class="btn-cancel" onclick="closeDeceasedConfirmModal()">Cancel</button>
              <button type="button" id="deceasedConfirmBtn" class="btn-primary" onclick="executeMarkDeceased()">Confirm</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Delete Evidence Item Confirmation Modal -->
      <div id="deleteEvidenceConfirmModal" class="modal" style="z-index:1400;">
        <div class="modal-content" style="max-width:400px;">
          <div class="modal-sidebar" style="background:#A00;">
            <span style="font-size:28px;">‚ö†</span>
          </div>
          <div class="modal-body">
            <h3 style="margin-top:0; margin-bottom:15px; font-size:16px;">Delete Evidence Item</h3>
            <p id="deleteEvidenceConfirmMessage" style="font-size:13px; color:#666; margin-bottom:20px;"></p>
            <div style="display:flex; gap:10px; justify-content:flex-end;">
              <button type="button" class="btn-cancel" onclick="closeDeleteEvidenceConfirmModal()">Cancel</button>
              <button type="button" class="btn-danger" onclick="executeDeleteEvidenceItem()">Delete</button>
            </div>
          </div>
        </div>
      </div>

      <div id="alertModal" class="modal">
        <div class="modal-content" style="width:550px; height:auto; max-height:80vh;">
          <div class="modal-sidebar" id="alertModalSidebar" style="width:60px; min-width:60px;">
            <span id="alertModalIcon" style="font-size:28px;">‚Ñπ</span>
          </div>
          <div class="modal-body" style="overflow-y:auto;">
            <h3 id="alertModalTitle" style="margin-top:0; margin-bottom:15px; font-size:16px;">Notice</h3>
            <p id="alertModalMessage" style="font-size:13px; color:#666; margin-bottom:20px; white-space:pre-line;"></p>
            <div style="display:flex; gap:10px; justify-content:flex-end;">
              <button type="button" class="btn-cancel" onclick="closeAlertModal()">OK</button>
            </div>
          </div>
        </div>
      </div>

      <div id="shortcutsModal" class="modal">
        <div class="modal-content" style="max-width:320px;">
          <div class="modal-sidebar">
            <img src="https://img1.wsimg.com/isteam/ip/2c5f94ee-4964-4e9b-9b9c-a55121f8611b/favicon/31eb51a1-8979-4194-bfa2-e4b30ee1178d/2437d5de-854d-40b2-86b2-fd879f3469f0.png/:/rs=w:64,h:64,m?v=3">
          </div>
          <div class="modal-body">
            <h3 style="margin-top:0; margin-bottom:15px; font-size:16px;">Keyboard Shortcuts</h3>
            <div class="shortcuts-list">
              <div class="shortcut-row"><kbd>/</kbd><span>Focus search</span></div>
              <div class="shortcut-row"><kbd>N</kbd><span>New client</span></div>
              <div class="shortcut-row"><kbd>E</kbd><span>Edit contact</span></div>
              <div class="shortcut-row"><kbd>Esc</kbd><span>Close panel/modal</span></div>
              <div class="shortcut-row"><kbd>?</kbd><span>Show this help</span></div>
            </div>
            <div style="margin-top:20px; display:flex; justify-content:flex-end;">
              <button type="button" class="btn-cancel" onclick="closeShortcutsModal()">Close</button>
            </div>
          </div>
        </div>
      </div>

      <div id="emailComposer" class="email-composer-modal">
        <div class="email-composer-content">
          <div class="email-composer-header">
            <h2>Appointment Confirmation Email</h2>
            <div style="display:flex; align-items:center; gap:8px;">
              <button class="settings-cog-small" onclick="openEmailSettings()" title="Edit Links & Templates">‚öô</button>
              <button class="close-panel" onclick="closeEmailComposer()">‚úï</button>
            </div>
          </div>
          <div class="email-composer-body">
            <div class="email-composer-settings">
              <div class="email-setting-group">
                <label>Appointment Type</label>
                <select id="emailApptType" onchange="updateEmailPreview()">
                  <option value="Office">Office</option>
                  <option value="Phone">Phone</option>
                  <option value="Video">Video</option>
                </select>
              </div>
              <div class="email-setting-group">
                <label>Client Type</label>
                <select id="emailClientType" onchange="updateEmailPreview()">
                  <option value="New">New Client</option>
                  <option value="Repeat">Repeat Client</option>
                </select>
              </div>
              <div class="email-setting-group">
                <label>Prep Handler</label>
                <select id="emailPrepHandler" onchange="updateEmailPreview()">
                  <option value="Shae">Shae (part-time)</option>
                  <option value="Team">Team (email Shae)</option>
                  <option value="OpenBanking">Open Banking (no docs)</option>
                </select>
              </div>
            </div>
            <div class="email-composer-fields">
              <div class="email-field-row">
                <label>To:</label>
                <input type="text" id="emailTo" readonly>
              </div>
              <div class="email-field-row">
                <label>Subject:</label>
                <input type="text" id="emailSubject" readonly>
              </div>
            </div>
            <div class="email-preview-container">
              <div class="email-preview-label" style="display:flex; justify-content:space-between; align-items:center;">
                <span>Email Body (editable)</span>
                <a href="#" onclick="event.preventDefault(); event.stopPropagation(); openCurrentTemplateEditor();" style="font-size:11px; color:var(--color-star); cursor:pointer;">Edit Template</a>
              </div>
              <div id="emailQuillContainer">
                <div id="emailQuillToolbar">
                  <span class="ql-formats">
                    <button class="ql-bold"></button>
                    <button class="ql-italic"></button>
                    <button class="ql-underline"></button>
                  </span>
                  <span class="ql-formats">
                    <button class="ql-link"></button>
                  </span>
                  <span class="ql-formats">
                    <button class="ql-list" value="ordered"></button>
                    <button class="ql-list" value="bullet"></button>
                  </span>
                  <span class="ql-formats">
                    <button class="ql-clean"></button>
                  </span>
                </div>
                <div id="emailPreviewBody" class="email-preview-body"></div>
              </div>
            </div>
          </div>
          <div class="email-composer-footer">
            <button type="button" class="btn-cancel" onclick="closeEmailComposer()">Cancel</button>
            <button type="button" class="btn-confirm" onclick="sendEmail()" id="emailSendBtn">Send</button>
          </div>
        </div>
      </div>

      <div id="emailSettingsModal" class="modal">
        <div class="modal-content" style="width:700px !important; height:auto !important; max-height:90vh;">
          <div class="modal-sidebar" style="background:var(--color-cedar); width:60px; min-width:60px;">
            <span style="font-size:24px;">‚öô</span>
          </div>
          <div class="modal-body" style="overflow-y:auto; max-height:calc(90vh - 40px); flex:1;">
            <h3 style="margin-top:0; margin-bottom:15px; font-size:16px;">Settings</h3>
            <p style="font-size:12px; color:#666; margin-bottom:15px;">These settings are shared with the whole team. Changes you make here will update for everyone.</p>
            <div style="margin-bottom:15px; padding:12px; background:var(--color-sky); border-radius:6px; display:flex; justify-content:space-between; align-items:center;">
              <div>
                <div style="font-weight:600; font-size:13px;">Email Templates</div>
                <div style="font-size:11px; color:#666;">Manage email templates with conditional content</div>
              </div>
              <button type="button" onclick="closeEmailSettings(); openTemplateList();" style="padding:8px 16px; background:var(--color-star); color:white; border:none; border-radius:4px; cursor:pointer; font-size:12px; font-weight:500;">Manage Templates</button>
            </div>
            <div style="display:flex; align-items:center; justify-content:space-between; padding:12px; background:#f8f8f8; border-radius:6px; margin-bottom:15px;">
              <div>
                <div style="font-weight:600; font-size:13px;">Evidence Templates</div>
                <div style="font-size:11px; color:#666;">Master templates for evidence/document requests</div>
              </div>
              <button type="button" onclick="closeEmailSettings(); openEvidenceTemplatesModal();" style="padding:8px 16px; background:var(--color-cedar); color:white; border:none; border-radius:4px; cursor:pointer; font-size:12px; font-weight:500;">Manage Evidence</button>
            </div>
            <div style="display:flex; align-items:center; justify-content:space-between; padding:12px; background:#f0f8f0; border-radius:6px; margin-bottom:15px; border:1px solid var(--color-cedar);">
              <div>
                <div style="font-weight:600; font-size:13px;">Phone Number Copy Format</div>
                <div style="font-size:11px; color:#666;">When you click a phone number to copy it</div>
              </div>
              <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:12px;">
                <input type="checkbox" id="settingPhoneCopySpaces" onchange="window.setPhoneCopyPreference(this.checked)">
                <span>Include spaces</span>
              </label>
            </div>
            <div class="email-settings-form">
              <div class="setting-row">
                <label>Office Map Link</label>
                <input type="url" id="settingOfficeMap" placeholder="https://...">
              </div>
              <div class="setting-row">
                <label>Our Team Page</label>
                <input type="url" id="settingOurTeam" placeholder="https://...">
              </div>
              <div class="setting-row">
                <label>Fact Find Document</label>
                <input type="url" id="settingFactFind" placeholder="https://...">
              </div>
              <div class="setting-row">
                <label>myGov Link</label>
                <input type="url" id="settingMyGov" placeholder="https://...">
              </div>
              <div class="setting-row">
                <label>myGov Help Video</label>
                <input type="url" id="settingMyGovVideo" placeholder="https://...">
              </div>
              <div class="setting-row">
                <label>Income Statement Instructions</label>
                <input type="url" id="settingIncomeInstructions" placeholder="https://...">
              </div>
              <div style="border-top:1px solid var(--color-border); margin-top:12px; padding-top:12px;">
                <div class="setting-row">
                  <label>Your Email Signature</label>
                  <div style="background:var(--color-sky); padding:8px 12px; border-radius:4px; margin-bottom:8px; display:flex; justify-content:space-between; align-items:center;">
                    <div style="font-size:11px; color:#555;">
                      <span id="sigGenName">Loading...</span> ¬∑ <span id="sigGenTitle"></span>
                    </div>
                    <div style="display:flex; gap:6px;">
                      <button type="button" onclick="regenerateSignature()" style="padding:4px 10px; background:var(--color-star); color:white; border:none; border-radius:4px; cursor:pointer; font-size:10px; font-weight:600; width:auto; margin:0;">Regenerate</button>
                      <button type="button" onclick="copySignatureForGmail()" style="padding:4px 10px; background:#555; color:white; border:none; border-radius:4px; cursor:pointer; font-size:10px; font-weight:500; width:auto; margin:0;">Copy for Gmail</button>
                      <button type="button" onclick="copySignatureForMercury()" style="padding:4px 10px; background:#555; color:white; border:none; border-radius:4px; cursor:pointer; font-size:10px; font-weight:500; width:auto; margin:0;">Copy for Mercury</button>
                    </div>
                  </div>
                  <div id="signaturePreviewContainer" style="background:#FFF; border:1px solid var(--color-border); border-radius:6px; padding:15px; min-height:80px; margin-bottom:8px; overflow:auto;"></div>
                  <span style="font-size:11px; color:#888; display:block;">Your signature is stored in Airtable and syncs across all your devices.</span>
                  <textarea id="settingSignature" style="display:none;"></textarea>
                </div>
              </div>
            </div>
            <div style="margin-top:20px; display:flex; justify-content:flex-end; gap:10px; padding-bottom:10px;">
              <button type="button" class="btn-cancel" onclick="closeEmailSettings()">Close</button>
              <button type="button" class="btn-confirm" onclick="saveEmailSettings()">Save</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Template Editor Modal -->
    <div id="templateEditorModal" class="modal-overlay" style="display:none;">
      <div class="modal-content template-editor-modal">
        <div class="modal-header">
          <h3 id="templateEditorTitle">Edit Template</h3>
          <button class="close-panel" onclick="closeTemplateEditor()">&times;</button>
        </div>
        <div class="template-editor-body">
          <div class="template-editor-grid">
            <!-- Row 1: Headers -->
            <div class="template-editor-panel-header">
              <span>Template Source</span>
            </div>
            <div class="template-editor-panel-header">
              <span>Live Preview</span>
              <span id="previewDataSource" class="preview-data-badge">Sample Data</span>
            </div>
            
            <!-- Row 2: Template Name (left) / Preview Controls (right) -->
            <div class="template-editor-cell template-name-cell">
              <div class="template-editor-field">
                <label>Template Name</label>
                <input type="text" id="templateEditorName" placeholder="e.g., Appointment Confirmation">
              </div>
            </div>
            <div class="template-editor-cell template-name-cell preview-controls-cell">
              <div class="preview-controls">
                <label>Preview As:</label>
                <div class="preview-control-row">
                  <select id="previewApptType" onchange="updateTemplatePreviewFromControls()">
                    <option value="Office">Office</option>
                    <option value="Phone">Phone</option>
                    <option value="Video">Video</option>
                  </select>
                  <select id="previewClientType" onchange="updateTemplatePreviewFromControls()">
                    <option value="New">New Client</option>
                    <option value="Repeat">Repeat Client</option>
                  </select>
                  <select id="previewPrepHandler" onchange="updateTemplatePreviewFromControls()">
                    <option value="Shae">Prep: Shae</option>
                    <option value="Team">Prep: Team</option>
                    <option value="OpenBanking">Prep: Open Banking</option>
                  </select>
                </div>
              </div>
            </div>
            
            <!-- Row 3: Subject -->
            <div class="template-editor-cell">
              <div class="template-editor-field template-subject-field">
                <label>Subject Line</label>
                <div id="templateEditorSubjectContainer">
                  <div id="templateEditorSubject" spellcheck="false"></div>
                </div>
              </div>
            </div>
            <div class="template-editor-cell preview-cell">
              <label>Subject Line</label>
              <div id="templatePreviewSubject" class="preview-subject-text"></div>
            </div>
            
            <!-- Row 4: Body -->
            <div class="template-editor-cell template-body-cell">
              <div class="template-editor-field template-body-field">
                <label>Email Body</label>
                <div id="templateEditorQuillContainer">
                  <div id="templateEditorToolbar">
                    <span class="ql-formats">
                      <button class="ql-bold"></button>
                      <button class="ql-italic"></button>
                      <button class="ql-underline"></button>
                    </span>
                    <span class="ql-formats">
                      <button class="ql-link"></button>
                    </span>
                    <span class="ql-formats">
                      <button class="ql-list" value="ordered"></button>
                      <button class="ql-list" value="bullet"></button>
                    </span>
                    <span class="ql-formats">
                      <button class="ql-clean"></button>
                    </span>
                  </div>
                  <div id="templateEditorBody" spellcheck="false"></div>
                </div>
              </div>
            </div>
            <div class="template-editor-cell preview-cell template-body-cell">
              <label>Email Body</label>
              <div id="templatePreviewBody" class="preview-body-content"></div>
            </div>
          </div>
          <div class="template-editor-sidebar">
            <div class="sidebar-section">
              <h4>Insert Variable</h4>
              <div id="variablePickerList" class="variable-picker-list"></div>
            </div>
            <div class="sidebar-section">
              <h4>Add Condition</h4>
              <div class="condition-builder">
                <select id="conditionVariable">
                  <option value="">Select variable...</option>
                  <option value="appointmentType">Appointment Type</option>
                  <option value="clientType">Client Type</option>
                  <option value="prepHandler">Prep Handler</option>
                </select>
                <div id="conditionOptionsContainer" style="display:none;">
                  <div class="condition-options" id="conditionOptions"></div>
                  <button type="button" class="btn-insert-condition" onclick="insertConditionBlock()">Insert Condition Block</button>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn-cancel" onclick="closeTemplateEditor()">Cancel</button>
          <button type="button" class="btn-confirm" id="templateEditorSaveBtn" onclick="saveTemplate()">Save Template</button>
        </div>
      </div>
    </div>

    <!-- Template List Modal (Central Hub) -->
    <div id="templateListModal" class="modal-overlay" style="display:none;">
      <div class="modal-content" style="max-width:700px;">
        <div class="modal-header">
          <h3>Email Templates</h3>
          <button class="close-panel" onclick="closeTemplateList()">&times;</button>
        </div>
        <div class="modal-body" style="padding:20px;">
          <p style="font-size:13px; color:#666; margin-bottom:15px;">Manage email templates used across the system. Changes apply to everyone.</p>
          <div id="templateListContainer"></div>
          <div style="margin-top:15px;">
            <button type="button" class="btn-confirm" onclick="createNewTemplate()">+ New Template</button>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn-cancel" onclick="closeTemplateList()">Close</button>
        </div>
      </div>
    </div>

    <!-- Evidence Templates Management Modal -->
    <div id="evidenceTemplatesModal" class="modal-overlay" style="display:none;">
      <div class="modal-content" style="max-width:900px; height:90vh; max-height:90vh; display:flex; flex-direction:column;">
        <div class="modal-header">
          <h3>Evidence Templates</h3>
          <button class="close-panel" onclick="closeEvidenceTemplatesModal()">&times;</button>
        </div>
        <div class="modal-body" style="padding:20px; overflow-y:auto; flex:1; background:#fff;">
          <p style="font-size:13px; color:#666; margin-bottom:15px;">Master templates used when creating evidence lists for new opportunities. Changes here affect future opportunities only.</p>
          <div style="display:flex; gap:10px; margin-bottom:15px;">
            <input type="text" id="evidenceTemplatesSearch" placeholder="Search templates..." style="flex:1; padding:8px 12px; border:1px solid #ddd; border-radius:4px; background:#fff;">
            <select id="evidenceTemplatesFilter" style="padding:8px 12px; border:1px solid #ddd; border-radius:4px; background:#fff;">
              <option value="">All Categories</option>
            </select>
          </div>
          <div id="evidenceTemplatesContainer" style="min-height:300px; background:#fff;"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn-cancel" onclick="closeEvidenceTemplatesModal()">Close</button>
          <button type="button" class="btn-confirm" onclick="openNewEvidenceTemplateForm()">+ New Template</button>
        </div>
      </div>
    </div>

    <!-- Evidence Template Edit Modal -->
    <div id="evidenceTemplateEditModal" class="modal-overlay" style="display:none; z-index:1300;">
      <div class="modal-content" style="max-width:950px; width:90%; height:80vh; max-height:80vh; display:flex; flex-direction:column;">
        <div class="modal-header">
          <h3 id="evidenceTemplateEditTitle">Edit Template</h3>
          <button class="close-panel" onclick="closeEvidenceTemplateEditModal()">&times;</button>
        </div>
        <div class="modal-body" style="padding:24px; background:#fff; flex:1; overflow-y:auto;">
          <div style="display:flex; gap:30px;">
            <!-- Left column: Main fields -->
            <div style="flex:1; min-width:0;">
              <div class="field-group" style="margin-bottom:16px;">
                <label>Name *</label>
                <input type="text" id="evTplEditName" placeholder="e.g., Payslips (last 2)" style="background:#fff; width:100%;">
              </div>
              <div class="field-group" style="margin-bottom:16px;">
                <label>Category</label>
                <select id="evTplEditCategory" style="background:#fff; width:100%;"></select>
              </div>
              <div class="field-group" style="margin-bottom:16px;">
                <label>Description (shown to clients)</label>
                <div id="evTplEditDescEditor" style="height:150px; border:1px solid #ddd; border-radius:4px; background:#fff;"></div>
              </div>
              <div class="form-row" style="display:flex; gap:20px;">
                <div class="field-group" style="width:120px;">
                  <label>Display Order</label>
                  <input type="number" id="evTplEditOrder" min="0" value="100" style="background:#fff; width:100%;">
                </div>
                <div class="field-group" style="flex:1; display:flex; align-items:center; padding-top:20px;">
                  <label style="display:flex; align-items:center; gap:8px; cursor:pointer; margin:0;">
                    <input type="checkbox" id="evTplEditLenderSpecific">
                    <span>Lender-Specific <span style="font-size:10px; color:#888;">(requires rules)</span></span>
                  </label>
                </div>
              </div>
            </div>
            <!-- Right column: Opportunity Types -->
            <div style="width:220px; flex-shrink:0; border-left:1px solid #eee; padding-left:24px;">
              <div class="field-group">
                <label style="margin-bottom:8px; display:block;">Opportunity Types</label>
                <p style="font-size:10px; color:#888; margin:0 0 12px;">Leave all unchecked to apply to all types</p>
                <div id="evTplEditOppTypes" style="display:flex; flex-direction:column; gap:8px;"></div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn-danger" id="evTplDeleteBtn" onclick="deleteEvidenceTemplate()" style="margin-right:auto;">Delete</button>
          <button type="button" class="btn-cancel" onclick="closeEvidenceTemplateEditModal()">Cancel</button>
          <button type="button" class="btn-confirm" id="evTplSaveBtn" onclick="saveEvidenceTemplate()">Save</button>
        </div>
      </div>
    </div>

    
    <div style="position:fixed; bottom:5px; right:10px; font-size:10px; color:#AAA; z-index:1000; font-family:sans-serif;">
       User: <span id="debugUser">Loading...</span> | <a href="/logout" style="color:#888; text-decoration:underline; cursor:pointer;">Log out</a> | v4.3 (Signature)
    </div>

    <!-- Appointment Form Modal -->
    <div id="appointmentFormModal" class="modal-overlay">
      <div class="modal-content" style="max-width:600px;">
        <div class="modal-header">
          <h3 id="appointmentFormTitle">New Appointment</h3>
          <button class="close-panel" onclick="closeAppointmentForm()">&times;</button>
        </div>
        <div class="modal-body" style="padding:20px;">
          <div class="form-row">
            <div class="field-group" style="flex:1;">
              <label>Date</label>
              <input type="text" id="apptFormDate" class="smart-date" placeholder="DD/MM/YYYY">
            </div>
            <div class="field-group" style="flex:1;">
              <label>Time</label>
              <input type="text" id="apptFormTime" class="smart-time" placeholder="e.g. 1300, 1:30pm">
            </div>
            <div class="field-group" style="flex:1;">
              <label>Status</label>
              <select id="apptFormStatus">
                <option value="">Not Set</option>
                <option value="Scheduled">Scheduled</option>
                <option value="Completed">Completed</option>
                <option value="Cancelled">Cancelled</option>
                <option value="No Show">No Show</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="field-group" style="flex:1;">
              <label>Type of Appointment</label>
              <select id="apptFormType" onchange="updateAppointmentFormVisibility()">
                <option value="Office">Office</option>
                <option value="Phone">Phone</option>
                <option value="Video">Video</option>
              </select>
            </div>
            <div class="field-group" style="flex:1;">
              <label>How Booked</label>
              <select id="apptFormHowBooked" onchange="updateAppointmentFormVisibility()">
                <option value="Calendly">Calendly</option>
                <option value="Email">Email</option>
                <option value="Phone">Phone</option>
                <option value="Podium">Podium</option>
                <option value="Other">Other</option>
              </select>
            </div>
          </div>
          <div class="form-row" id="apptFormHowBookedOtherRow" style="display:none;">
            <div class="field-group" style="flex:1;">
              <label>How Booked (Other)</label>
              <input type="text" id="apptFormHowBookedOther" placeholder="Specify how booked">
            </div>
          </div>
          <div class="form-row" id="apptFormPhoneRow" style="display:none;">
            <div class="field-group" style="flex:1;">
              <label>Phone Number</label>
              <input type="text" id="apptFormPhone" placeholder="Client phone number">
            </div>
          </div>
          <div class="form-row" id="apptFormMeetRow" style="display:none;">
            <div class="field-group" style="flex:1;">
              <label>Video Meet URL</label>
              <input type="text" id="apptFormMeetUrl" placeholder="meet.google.com/xxx-xxxx-xxx">
            </div>
          </div>
          <div class="form-row">
            <div class="field-group" style="flex:1;">
              <label style="display:flex; align-items:center; gap:8px;">
                <input type="checkbox" id="apptFormNeedEvidence" style="width:auto; margin:0;">
                Need Evidence in Advance
              </label>
            </div>
            <div class="field-group" style="flex:1;">
              <label style="display:flex; align-items:center; gap:8px;">
                <input type="checkbox" id="apptFormNeedReminder" style="width:auto; margin:0;">
                Need Appointment Reminder
              </label>
            </div>
          </div>
          <div class="form-row">
            <div class="field-group" style="flex:1;">
              <label>Notes</label>
              <textarea id="apptFormNotes" rows="3" placeholder="Additional notes..."></textarea>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn-cancel" onclick="closeAppointmentForm()">Cancel</button>
          <button type="button" id="apptFormSaveBtn" class="btn-confirm" onclick="saveAppointment()">Save</button>
        </div>
      </div>
    </div>

    <!-- Address Form Modal -->
    <div id="addressFormModal" class="modal-overlay" style="display:none; z-index:1200;">
      <div class="modal-content" style="width:550px; max-width:95vw; height:620px;">
        <div class="modal-header">
          <h3 id="addressFormTitle" style="white-space:nowrap;">Add Address</h3>
          <button type="button" class="close-panel" onclick="closeAddressForm()">&times;</button>
        </div>
        <div class="modal-body" id="addressFormBody" style="padding:20px;">
          <input type="hidden" id="addressFormId">
          <input type="hidden" id="addressFormIsPostal" value="false">
          
          <div class="form-row">
            <div class="field-group" style="flex:1;">
              <label>Format</label>
              <div style="display:flex; gap:15px;">
                <label style="display:flex; align-items:center; gap:5px; font-weight:normal; cursor:pointer;">
                  <input type="radio" name="addressFormat" value="Standard" checked onchange="updateAddressFormatFields()"> Standard
                </label>
                <label style="display:flex; align-items:center; gap:5px; font-weight:normal; cursor:pointer;">
                  <input type="radio" name="addressFormat" value="Non-Standard" onchange="updateAddressFormatFields()"> Non-Standard
                </label>
                <label style="display:flex; align-items:center; gap:5px; font-weight:normal; cursor:pointer;">
                  <input type="radio" name="addressFormat" value="PO Box" onchange="updateAddressFormatFields()"> PO Box
                </label>
              </div>
            </div>
          </div>

          <!-- Non-Standard Only Fields -->
          <div id="addressNonStandardFields" style="display:none;">
            <div class="form-row">
              <div class="field-group" style="flex:1;"><label>Floor</label><input type="text" id="addressFloor"></div>
              <div class="field-group" style="flex:1;"><label>Building</label><input type="text" id="addressBuilding"></div>
              <div class="field-group" style="flex:1;"><label>Unit</label><input type="text" id="addressUnit"></div>
            </div>
          </div>

          <!-- PO Box Only Field -->
          <div id="addressPOBoxFields" style="display:none;">
            <div class="form-row">
              <div class="field-group" style="flex:1;"><label>PO Box / Label</label><input type="text" id="addressLabel" placeholder="e.g. PO Box 123"></div>
            </div>
          </div>

          <!-- Standard + Non-Standard Fields -->
          <div id="addressStreetFields">
            <div class="form-row">
              <div class="field-group" style="flex:0 0 100px;"><label>Street No</label><input type="text" id="addressStreetNo"></div>
              <div class="field-group" style="flex:1;"><label>Street Name</label><input type="text" id="addressStreetName"></div>
              <div class="field-group" style="flex:0 0 140px;">
                <label>Street Type <span class="tooltip-icon" title="If the Street Type you want isn't here, please ask Tim to add it to the list: Airtable->Addresses->Street Type. That's all that needs to happen. 1 minute and it's done.">?</span></label>
                <select id="addressStreetType">
                  <option value=""></option>
                  <option value="Access">Access</option><option value="Alley">Alley</option><option value="Arcade">Arcade</option>
                  <option value="Avenue">Avenue</option><option value="Boulevard">Boulevard</option><option value="Close">Close</option>
                  <option value="Court">Court</option><option value="Crescent">Crescent</option><option value="Drive">Drive</option>
                  <option value="Esplanade">Esplanade</option><option value="Freeway">Freeway</option><option value="Gardens">Gardens</option>
                  <option value="Grove">Grove</option><option value="Highway">Highway</option><option value="Lane">Lane</option>
                  <option value="Link">Link</option><option value="Loop">Loop</option><option value="Mall">Mall</option>
                  <option value="Parade">Parade</option><option value="Parkway">Parkway</option><option value="Place">Place</option>
                  <option value="Plaza">Plaza</option><option value="Promenade">Promenade</option><option value="Quay">Quay</option>
                  <option value="Rise">Rise</option><option value="Road">Road</option><option value="Row">Row</option>
                  <option value="Square">Square</option><option value="Street">Street</option><option value="Terrace">Terrace</option>
                  <option value="Track">Track</option><option value="Trail">Trail</option><option value="View">View</option>
                  <option value="Vista">Vista</option><option value="Walk">Walk</option><option value="Way">Way</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Common Fields (all formats) -->
          <div class="form-row">
            <div class="field-group" style="flex:1;"><label>City / Suburb</label><input type="text" id="addressCity"></div>
            <div class="field-group" style="flex:0 0 80px;">
              <label>State</label>
              <select id="addressState">
                <option value=""></option>
                <option value="WA">WA</option><option value="NSW">NSW</option><option value="VIC">VIC</option>
                <option value="QLD">QLD</option><option value="SA">SA</option><option value="TAS">TAS</option>
                <option value="NT">NT</option><option value="ACT">ACT</option>
              </select>
            </div>
            <div class="field-group" style="flex:0 0 80px;"><label>Postcode</label><input type="text" id="addressPostcode" maxlength="4"></div>
          </div>
          <div class="form-row">
            <div class="field-group" style="flex:1;">
              <label>Country <span class="tooltip-icon" title="If the Country you want isn't here, please ask Tim to add it to the list: Airtable->Addresses->Country. That's all that needs to happen. 1 minute and it's done.">?</span></label>
              <select id="addressCountry">
                <option value="Australia">Australia</option><option value="New Zealand">New Zealand</option>
                <option value="United Kingdom">United Kingdom</option><option value="United States">United States</option>
                <option value="China">China</option><option value="India">India</option><option value="Philippines">Philippines</option>
                <option value="Vietnam">Vietnam</option><option value="South Africa">South Africa</option>
                <option value="Malaysia">Malaysia</option><option value="Singapore">Singapore</option>
                <option value="Indonesia">Indonesia</option><option value="Hong Kong">Hong Kong</option>
                <option value="Ireland">Ireland</option><option value="Canada">Canada</option><option value="Germany">Germany</option>
                <option value="Italy">Italy</option><option value="Greece">Greece</option><option value="Netherlands">Netherlands</option>
                <option value="France">France</option><option value="Other">Other</option>
              </select>
            </div>
          </div>

          <div id="addressResidentialFields">
            <hr style="margin:15px 0; border:0; border-top:1px solid #ddd;">

            <div class="form-row">
              <div class="field-group" style="flex:1;">
                <label>Status</label>
                <select id="addressStatus">
                  <option value=""></option>
                  <option value="Own Home">Own Home</option>
                  <option value="Boarding">Boarding</option>
                  <option value="Caravan">Caravan</option>
                  <option value="Own Home - Mortgage">Own Home - Mortgage</option>
                  <option value="Renting">Renting</option>
                  <option value="With Parents">With Parents</option>
                  <option value="Other">Other</option>
                </select>
              </div>
            </div>
            <div class="form-row">
              <div class="field-group" style="flex:1;"><label>From (Move-in Date)</label><input type="text" id="addressFrom" class="smart-date" placeholder="DD/MM/YYYY"></div>
              <div class="field-group" style="flex:1;"><label>To (Move-out Date)</label><input type="text" id="addressTo" class="smart-date" placeholder="DD/MM/YYYY (leave blank if current)"></div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn-delete" id="addressDeleteBtn" onclick="deleteAddress()" style="margin-right:auto; display:none;">Delete</button>
          <button type="button" class="btn-cancel" onclick="closeAddressForm()">Cancel</button>
          <button type="button" class="btn-confirm" onclick="saveAddress()">Save</button>
        </div>
      </div>
    </div>

    <!-- Postal Address Copy Modal -->
    <div id="postalAddressCopyModal" class="modal-overlay" style="display:none; z-index:1250;">
      <div class="modal-content" style="min-width:400px; max-width:95vw;">
        <div class="modal-header">
          <h3 style="white-space:nowrap;">Set Postal Address</h3>
          <button type="button" class="close-panel" onclick="closePostalCopyModal()">&times;</button>
        </div>
        <div class="modal-body" style="padding:20px;">
          <p style="margin-bottom:15px; font-size:13px;">Would you like to copy from an existing address or enter a new one?</p>
          <div id="postalAddressCopyList" style="max-height:200px; overflow-y:auto; margin-bottom:15px;"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn-cancel" onclick="closePostalCopyModal()">Cancel</button>
          <button type="button" class="btn-confirm" onclick="openPostalAddressNew()">Enter New Address</button>
        </div>
      </div>
    </div>

    <!-- Employment Modal -->
    <div id="employmentModal" class="modal-overlay" style="display:none; z-index:1200;">
      <div class="modal-content" style="width:800px; max-width:95vw; max-height:90vh;">
        <div class="modal-header">
          <h3 id="employmentFormTitle" style="white-space:nowrap;">Add Employment</h3>
          <button type="button" class="close-panel" onclick="closeEmploymentModal()">&times;</button>
        </div>
        <div class="modal-body" id="employmentFormBody" style="padding:20px; overflow-y:auto; max-height:calc(90vh - 130px);">
          <input type="hidden" id="employmentFormId">
          
          <div class="form-row">
            <div class="field-group" style="flex:1;">
              <label>Status</label>
              <select id="employmentStatus" onchange="handleEmploymentStatusChange()">
                <option value="">Select...</option>
                <option value="Primary Employment">Primary Employment</option>
                <option value="Secondary Employment">Secondary Employment</option>
                <option value="Previous Employment">Previous Employment</option>
              </select>
            </div>
            <div class="field-group" style="flex:1;">
              <label>Employment Type</label>
              <select id="employmentType" onchange="handleEmploymentTypeChange()">
                <option value="">Select...</option>
                <option value="PAYG">PAYG</option>
                <option value="Self Employed">Self Employed</option>
                <option value="Unemployed">Unemployed</option>
                <option value="Retired">Retired</option>
              </select>
            </div>
          </div>

          <div id="employmentEmployerSection">
            <div class="form-row">
              <div class="field-group" style="flex:2;"><label>Employer Name</label><input type="text" id="employmentEmployerName"></div>
              <div class="field-group" style="flex:1;"><label>ABN</label><input type="text" id="employmentAbn"></div>
            </div>
            <div class="form-row">
              <div class="field-group" style="flex:1;"><label>Job Title</label><input type="text" id="employmentJobTitle"></div>
              <div class="field-group" style="flex:1;">
                <label>Employment Basis</label>
                <select id="employmentBasis">
                  <option value="">Select...</option>
                  <option value="Full Time">Full Time</option>
                  <option value="Part Time">Part Time</option>
                  <option value="Casual">Casual</option>
                  <option value="Contract">Contract</option>
                  <option value="Temporary">Temporary</option>
                </select>
              </div>
            </div>
          </div>

          <div id="employmentPaygSection" style="display:none;">
            <div class="form-row">
              <div class="field-group" style="flex:1;">
                <label>PAYG Type</label>
                <select id="employmentPaygType">
                  <option value="">Select...</option>
                  <option value="Public">Public</option>
                  <option value="Private">Private</option>
                </select>
              </div>
              <div class="field-group" style="flex:1;">
                <label style="display:flex; align-items:center; gap:8px;">
                  <input type="checkbox" id="employmentOnProbation" style="width:auto;">
                  On Probation
                </label>
              </div>
            </div>
          </div>

          <div id="employmentSelfEmployedSection" style="display:none;">
            <div class="form-row">
              <div class="field-group" style="flex:1;">
                <label>Operating Structure</label>
                <select id="employmentOperatingStructure">
                  <option value="">Select...</option>
                  <option value="Sole Trader/Partnership">Sole Trader/Partnership</option>
                  <option value="Trust">Trust</option>
                  <option value="Company">Company</option>
                </select>
              </div>
            </div>
          </div>

          <div id="employmentBenefitsSection" style="display:none;">
            <div class="form-row">
              <div class="field-group" style="flex:1;">
                <label style="display:flex; align-items:center; gap:8px;">
                  <input type="checkbox" id="employmentOnBenefits" style="width:auto;">
                  Receiving Government Benefits
                </label>
              </div>
              <div class="field-group" style="flex:1;">
                <label style="display:flex; align-items:center; gap:8px;">
                  <input type="checkbox" id="employmentStudent" style="width:auto;">
                  Student
                </label>
              </div>
            </div>
          </div>

          <div class="form-row">
            <div class="field-group" style="flex:1;"><label>Start Date</label><input type="text" id="employmentStartDate" class="smart-date" placeholder="DD/MM/YYYY"></div>
            <div class="field-group" style="flex:1;"><label>End Date</label><input type="text" id="employmentEndDate" class="smart-date" placeholder="DD/MM/YYYY (leave blank if current)"></div>
          </div>

          <div id="employmentContactPersonSection">
            <div style="margin-top:15px; margin-bottom:10px; font-weight:600; font-size:13px; color:#666;">Employer Contact Person</div>
            <div class="form-row">
              <div class="field-group" style="flex:0 0 80px;">
                <label>Title</label>
                <input type="text" id="employmentContactTitle">
              </div>
              <div class="field-group" style="flex:1;"><label>First Name</label><input type="text" id="employmentContactFirstName"></div>
              <div class="field-group" style="flex:1;"><label>Surname</label><input type="text" id="employmentContactSurname"></div>
            </div>
            <div class="form-row">
              <div class="field-group" style="flex:1;"><label>Phone</label><input type="text" id="employmentContactPhone"></div>
              <div class="field-group" style="flex:1;"><label>Email</label><input type="email" id="employmentContactEmail"></div>
            </div>
          </div>

          <div id="employmentAddressSection">
            <div style="margin-top:15px; margin-bottom:10px; font-weight:600; font-size:13px; color:#666;">Employer Address</div>
            <div class="form-row">
              <div class="field-group" style="flex:0 0 100px;"><label>Street No</label><input type="text" id="employmentAddrStreetNo"></div>
              <div class="field-group" style="flex:1;"><label>Street Name</label><input type="text" id="employmentAddrStreetName"></div>
              <div class="field-group" style="flex:0 0 120px;">
                <label>Street Type</label>
                <select id="employmentAddrStreetType">
                  <option value=""></option>
                  <option value="Avenue">Avenue</option><option value="Boulevard">Boulevard</option>
                  <option value="Close">Close</option><option value="Court">Court</option>
                  <option value="Crescent">Crescent</option><option value="Drive">Drive</option>
                  <option value="Highway">Highway</option><option value="Lane">Lane</option>
                  <option value="Parade">Parade</option><option value="Place">Place</option>
                  <option value="Road">Road</option><option value="Street">Street</option>
                  <option value="Terrace">Terrace</option><option value="Way">Way</option>
                </select>
              </div>
            </div>
            <div class="form-row">
              <div class="field-group" style="flex:1;"><label>City / Suburb</label><input type="text" id="employmentAddrCity"></div>
              <div class="field-group" style="flex:0 0 80px;">
                <label>State</label>
                <select id="employmentAddrState">
                  <option value=""></option>
                  <option value="WA">WA</option><option value="NSW">NSW</option><option value="VIC">VIC</option>
                  <option value="QLD">QLD</option><option value="SA">SA</option><option value="TAS">TAS</option>
                  <option value="NT">NT</option><option value="ACT">ACT</option>
                </select>
              </div>
              <div class="field-group" style="flex:0 0 80px;"><label>Postcode</label><input type="text" id="employmentAddrPostcode" maxlength="4"></div>
            </div>
          </div>

          <div id="employmentIncomeSection">
            <div style="margin-top:15px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center;">
              <span style="font-weight:600; font-size:13px; color:#666;">Income</span>
              <span id="employmentAddIncomeBtn" class="address-section-add" onclick="addIncomeRow()">+ Add Income</span>
            </div>
            <div id="employmentIncomeList"></div>
          </div>

        </div>
        <div class="modal-footer">
          <button type="button" class="btn-delete" id="employmentDeleteBtn" onclick="confirmDeleteEmployment()" style="margin-right:auto; display:none;">Delete</button>
          <button type="button" class="btn-cancel" onclick="closeEmploymentModal()">Cancel</button>
          <button type="button" class="btn-confirm" onclick="saveEmployment()">Save</button>
        </div>
      </div>
    </div>

    <!-- Employment Primary Conflict Modal -->
    <div id="employmentConflictModal" class="modal-overlay" style="display:none; z-index:1300;">
      <div class="modal-content" style="width:450px; max-width:95vw;">
        <div class="modal-header">
          <h3 style="white-space:nowrap;">Primary Employment Conflict</h3>
          <button type="button" class="close-panel" onclick="closeEmploymentConflictModal()">&times;</button>
        </div>
        <div class="modal-body" style="padding:20px;">
          <p id="employmentConflictMessage" style="margin-bottom:15px;"></p>
          <p style="font-size:13px; color:#666;">What would you like to do with the existing primary employment?</p>
          <div id="conflictEndDateField" style="display:none; margin-top:15px;">
            <label style="font-size:12px; color:#666; display:block; margin-bottom:5px;">End Date for previous Primary role:</label>
            <input type="text" id="conflictEndDateInput" class="smart-date" placeholder="DD/MM/YYYY">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn-cancel" onclick="closeEmploymentConflictModal()">Cancel</button>
          <button type="button" id="conflictSecondaryBtn" class="btn-secondary" onclick="resolveConflictAsSecondary()">Change to Secondary</button>
          <button type="button" id="conflictPreviousBtn" class="btn-confirm" onclick="showConflictDateInput()">Change to Previous</button>
          <button type="button" id="confirmConflictPreviousBtn" class="btn-confirm" style="display:none;" onclick="resolveConflictAsPrevious()">Confirm Change</button>
        </div>
      </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmModal" class="confirm-modal-overlay" style="display:none;">
      <div class="confirm-modal">
        <div class="confirm-modal-body">
          <p id="confirmModalMessage">Are you sure?</p>
        </div>
        <div class="confirm-modal-footer">
          <button type="button" class="btn-cancel" id="confirmModalCancel">Cancel</button>
          <button type="button" class="btn-confirm" id="confirmModalOk">Confirm</button>
        </div>
      </div>
    </div>

    <!-- Evidence Modal (Full Screen) -->
    <div id="evidenceModal" class="evidence-modal">
      <div class="evidence-modal-content">
        <div class="evidence-modal-header">
          <div class="evidence-header-left">
            <button type="button" class="evidence-close-btn" onclick="closeEvidenceModal()">‚úï</button>
            <div class="evidence-header-title">
              <h2>Evidence & Data Collection</h2>
              <p id="evidenceOppName" class="evidence-opp-name"></p>
            </div>
          </div>
          <div class="evidence-header-right">
            <div class="evidence-progress">
              <div class="evidence-progress-bar">
                <div id="evidenceProgressFill" class="evidence-progress-fill"></div>
              </div>
              <span id="evidenceProgressText" class="evidence-progress-text">0%</span>
            </div>
          </div>
        </div>
        <div class="evidence-modal-toolbar">
          <div class="evidence-toolbar-left">
            <button type="button" class="evidence-btn" onclick="openAddEvidenceItemModal()">+ Add Custom Item</button>
            <button type="button" class="evidence-btn" onclick="openEvidenceClientView()">üëÅ View Client Version</button>
            <div class="evidence-email-dropdown">
              <button type="button" class="evidence-btn evidence-email-btn" onclick="toggleEvidenceEmailMenu()">‚úâÔ∏è Email <span class="dropdown-arrow">‚ñæ</span></button>
              <div id="evidenceEmailMenu" class="evidence-dropdown-menu">
                <button onclick="generateEvidenceEmail('appointment')">Appointment Confirmation</button>
                <button onclick="generateEvidenceEmail('initial')">Initial Request</button>
                <button onclick="generateEvidenceEmail('subsequent')">Subsequent Request</button>
              </div>
            </div>
          </div>
          <div class="evidence-toolbar-right">
            <label class="evidence-filter-label">Filter:</label>
            <select id="evidenceStatusFilter" onchange="filterEvidenceItems()">
              <option value="all">All Items</option>
              <option value="outstanding">Outstanding Only</option>
              <option value="received">Received Only</option>
            </select>
            <label class="evidence-checkbox-label">
              <input type="checkbox" id="evidenceShowNA" checked onchange="filterEvidenceItems()">
              <span>Show N/A</span>
            </label>
            <label class="evidence-checkbox-label">
              <input type="checkbox" id="evidenceOutstandingFirst" onchange="filterEvidenceItems()">
              <span>Outstanding First</span>
            </label>
            <button type="button" class="evidence-btn-text" onclick="populateEvidenceFromTemplates()">+ Add from Templates</button>
          </div>
        </div>
        <div id="evidenceModalBody" class="evidence-modal-body">
          <div id="evidenceLoading" class="evidence-loading">Loading evidence items...</div>
          <div id="evidenceEmptyState" class="evidence-empty-state" style="display:none;">
            <p>No evidence items yet.</p>
            <button type="button" class="evidence-btn-primary" onclick="populateEvidenceFromTemplates()">Populate from Templates</button>
          </div>
          <div id="evidenceItemsContainer"></div>
        </div>
        <div class="evidence-modal-footer">
          <button type="button" class="evidence-btn-secondary" onclick="openManageTemplatesModal()">Manage Default Templates</button>
        </div>
      </div>
    </div>

    <!-- Add Evidence Item Modal -->
    <div id="addEvidenceItemModal" class="modal-overlay" style="z-index:1300;">
      <div class="modal-content" style="width:750px; max-width:90vw; min-height:550px;">
        <div class="modal-header">
          <h3>Add Custom Evidence Item</h3>
          <button type="button" class="close-panel" onclick="closeAddEvidenceItemModal()">&times;</button>
        </div>
        <div class="modal-body" style="padding:20px;">
          <div class="field-group" style="margin-bottom:15px;">
            <label>Category</label>
            <select id="newEvidenceCategory">
              <option value="Identification">Identification</option>
              <option value="Income">Income</option>
              <option value="Assets">Assets</option>
              <option value="Liabilities">Liabilities</option>
              <option value="Refinance">Refinance</option>
              <option value="Purchase & Property">Purchase & Property</option>
              <option value="Construction">Construction</option>
              <option value="Expenses">Expenses</option>
              <option value="Other">Other</option>
            </select>
          </div>
          <div class="field-group" style="margin-bottom:15px;">
            <label>Name</label>
            <input type="text" id="newEvidenceName" placeholder="e.g., Bank Statement">
          </div>
          <div class="field-group" style="margin-bottom:15px;">
            <label>Description (supports rich text - bold, links, etc.)</label>
            <div id="newEvidenceDescToolbar">
              <span class="ql-formats">
                <button class="ql-bold"></button>
                <button class="ql-italic"></button>
                <button class="ql-underline"></button>
              </span>
              <span class="ql-formats">
                <button class="ql-link"></button>
              </span>
              <span class="ql-formats">
                <button class="ql-list" value="bullet"></button>
              </span>
            </div>
            <div id="newEvidenceDescEditor" style="height:150px; background:#FFF; border:1px solid #DDD; border-top:none; border-radius:0 0 4px 4px;"></div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn-secondary" onclick="closeAddEvidenceItemModal()">Cancel</button>
          <button type="button" class="btn-primary" onclick="submitNewEvidenceItem()">Add Item</button>
        </div>
      </div>
    </div>

    <!-- Evidence Client View Modal -->
    <div id="evidenceClientViewModal" class="modal-overlay" style="z-index:1250;">
      <div class="modal-content" style="width:800px; max-width:95vw; height:auto; max-height:90vh; display:flex; flex-direction:column;">
        <div class="modal-header">
          <h3>Client View - Evidence List</h3>
          <button type="button" class="close-panel" onclick="closeEvidenceClientView()">&times;</button>
        </div>
        <div class="modal-body" style="padding:20px; flex:1; overflow-y:auto;">
          <p style="color:#888; font-size:13px; margin-bottom:15px;">This is how the list will appear when pasted into an email. Review and click "Copy to Clipboard" when ready.</p>
          <div id="evidenceClientViewContent" style="background:#FFF; border:1px solid #DDD; border-radius:8px; padding:20px; font-size:13px; font-family:Arial,sans-serif; line-height:1.5;"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn-secondary" onclick="closeEvidenceClientView()">Close</button>
          <button type="button" class="btn-primary" onclick="copyEvidenceClientView()">Copy to Clipboard</button>
        </div>
      </div>
    </div>

    <!-- Evidence Email Preview Modal -->
    <div id="evidenceEmailModal" class="modal-overlay" style="z-index:1250;">
      <div class="modal-content" style="width:900px; max-width:95vw; height:90vh; max-height:90vh; display:flex; flex-direction:column;">
        <div class="modal-header">
          <h3 id="evidenceEmailModalTitle">Compose Email</h3>
          <button type="button" class="close-panel" onclick="closeEvidenceEmailModal()">&times;</button>
        </div>
        <div class="modal-body" style="padding:20px; flex:1; display:flex; flex-direction:column; min-height:0; background:#f5f5f5;">
          <div style="display:flex; gap:15px; margin-bottom:15px;">
            <div class="field-group" style="flex:1;">
              <label>To</label>
              <input type="text" id="evidenceEmailTo" style="width:100%; padding:8px; border:1px solid #DDD; border-radius:4px; background:#fff;">
            </div>
            <div class="field-group" style="flex:2;">
              <label>Subject</label>
              <input type="text" id="evidenceEmailSubject" style="width:100%; padding:8px; border:1px solid #DDD; border-radius:4px; background:#fff;">
            </div>
          </div>
          <div class="field-group" style="flex:1; display:flex; flex-direction:column; min-height:0;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
              <label style="margin:0;">Message <span style="font-weight:normal; color:#888; font-size:11px;">(click to edit anywhere)</span></label>
              <div style="display:flex; gap:6px; align-items:center;">
                <button type="button" onclick="emailEditorCommand('bold')" title="Bold" style="padding:5px 8px; border:1px solid #ddd; border-radius:3px; background:#f8f8f8; cursor:pointer; font-weight:bold; font-family:Georgia,serif; font-size:14px; color:#444; min-width:28px;">B</button>
                <button type="button" onclick="emailEditorCommand('italic')" title="Italic" style="padding:5px 8px; border:1px solid #ddd; border-radius:3px; background:#f8f8f8; cursor:pointer; font-style:italic; font-family:Georgia,serif; font-size:14px; color:#444; min-width:28px;">I</button>
                <button type="button" onclick="emailEditorCommand('createLink')" title="Insert Link" style="padding:5px 8px; border:1px solid #ddd; border-radius:3px; background:#f8f8f8; cursor:pointer; font-size:13px; color:#444; min-width:28px;">&#128279;</button>
                <span style="border-left:1px solid #ddd; height:20px; margin:0 6px;"></span>
                <button type="button" onclick="resetEmailToTemplate()" title="Reset to original template" style="padding:5px 10px; border:1px solid #ddd; border-radius:3px; background:#f8f8f8; cursor:pointer; font-size:11px; color:#666;">reset</button>
              </div>
            </div>
            <iframe id="evidenceEmailEditor" style="flex:1; width:100%; border:1px solid #DDD; border-radius:4px; background:#fff; min-height:300px;"></iframe>
          </div>
          <p style="font-size:12px; color:#666; margin-top:12px; background:#fff; padding:10px; border-radius:4px; border-left:3px solid var(--color-star);">
            <strong><span id="evidenceEmailItemCount">0</span> outstanding item(s)</strong> will be marked as "Requested" when sent.
          </p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn-secondary" onclick="closeEvidenceEmailModal()">Cancel</button>
          <button type="button" class="btn-primary" id="evidenceEmailSendBtn" onclick="sendEvidenceEmail()">Send Email</button>
        </div>
      </div>
    </div>

    <!-- Edit Evidence Item Modal -->
    <div id="editEvidenceItemModal" class="modal-overlay" style="z-index:1300;">
      <div class="modal-content" style="width:750px; max-width:90vw; height:auto; max-height:90vh; display:flex; flex-direction:column;">
        <div class="modal-header">
          <h3>Edit Evidence Item</h3>
          <button type="button" class="close-panel" onclick="closeEditEvidenceItemModal()">&times;</button>
        </div>
        <div class="modal-body" style="padding:20px; flex:1; overflow-y:auto;">
          <input type="hidden" id="editEvidenceItemId">
          <div class="field-group" style="margin-bottom:20px;">
            <label>Category</label>
            <select id="editEvidenceCategory">
              <option value="Identification">Identification</option>
              <option value="Income">Income</option>
              <option value="Assets">Assets</option>
              <option value="Liabilities">Liabilities</option>
              <option value="Refinance">Refinance</option>
              <option value="Purchase & Property">Purchase & Property</option>
              <option value="Construction">Construction</option>
              <option value="Expenses">Expenses</option>
              <option value="Other">Other</option>
            </select>
          </div>
          <div class="field-group" style="margin-bottom:20px;">
            <label>Name</label>
            <input type="text" id="editEvidenceName" placeholder="e.g., Bank Statement">
          </div>
          <div class="field-group" style="margin-bottom:20px;">
            <label>Description</label>
            <div id="editEvidenceDescToolbar">
              <span class="ql-formats">
                <button class="ql-bold"></button>
                <button class="ql-italic"></button>
                <button class="ql-underline"></button>
              </span>
              <span class="ql-formats">
                <button class="ql-link"></button>
              </span>
              <span class="ql-formats">
                <button class="ql-list" value="bullet"></button>
              </span>
            </div>
            <div id="editEvidenceDescEditor" style="height:180px; background:#FFF; border:1px solid #DDD; border-top:none; border-radius:0 0 4px 4px;"></div>
          </div>
          <div class="field-group" style="margin-bottom:10px;">
            <label>Internal Notes (not visible to client)</label>
            <textarea id="editEvidenceNotes" rows="4" style="width:100%; padding:10px; border:1px solid #DDD; border-radius:4px; font-family:inherit; box-sizing:border-box;"></textarea>
          </div>
        </div>
        <div class="modal-footer" style="display:flex; justify-content:space-between; align-items:center; gap:15px;">
          <button type="button" class="btn-danger" style="padding:8px 16px; font-size:13px;" onclick="deleteEvidenceItem()">Delete Item</button>
          <div style="display:flex; gap:10px;">
            <button type="button" class="btn-secondary" style="padding:8px 16px;" onclick="closeEditEvidenceItemModal()">Cancel</button>
            <button type="button" class="btn-primary" style="padding:8px 16px;" onclick="saveEditedEvidenceItem()">Save Changes</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Duplicate Warning Modal (at body level for proper z-index) -->
    <div id="duplicateWarningModal" class="modal">
      <div class="modal-content" style="width:500px; height:auto; max-height:80vh;">
        <div class="modal-sidebar" style="background:var(--color-star); width:60px; min-width:60px;">
          <span style="font-size:24px;">‚ö†Ô∏è</span>
        </div>
        <div class="modal-body" style="overflow-y:auto;">
          <h3 id="duplicateWarningModalTitle" style="margin-top:0; margin-bottom:15px; font-size:16px;">Duplicate Warning</h3>
          <p style="font-size:12px; color:#666; margin-bottom:15px;">Enter a warning message to help distinguish this contact from others with similar names.</p>
          <div class="field-group">
            <label>Warning Message</label>
            <textarea id="duplicateWarningInput" rows="3" style="width:100%; resize:vertical; font-size:13px;" placeholder="e.g. This is Clare with middle name Louise, not the other Clare Mitchell."></textarea>
          </div>
          <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:20px;">
            <button type="button" class="btn-cancel" onclick="closeDuplicateWarningModal()">Cancel</button>
            <button type="button" class="btn-confirm" onclick="saveDuplicateWarning()">Save</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Duplicate Detection Modal (at body level for proper z-index) -->
    <div id="duplicateDetectionModal" class="modal">
      <div class="modal-content duplicate-detection-modal">
        <div class="modal-sidebar warning-sidebar">
          <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
            <line x1="12" y1="9" x2="12" y2="13"/>
            <line x1="12" y1="17" x2="12.01" y2="17"/>
          </svg>
        </div>
        <div class="modal-body">
          <h3 class="duplicate-modal-title">Potential Duplicate Found</h3>
          <p class="duplicate-modal-subtitle">We found existing contacts that may match the one you're creating. Please review before proceeding.</p>
          <div id="duplicateDetectionList" class="duplicate-list"></div>
          <div id="duplicateWarningPrompt" class="duplicate-warning-prompt">
            <label class="duplicate-checkbox-label">
              <input type="checkbox" id="addWarningAfterCreate" checked>
              <span>Add a Duplicate Warning to both Contacts after creation (recommended)</span>
            </label>
          </div>
          <div class="duplicate-modal-actions">
            <button type="button" class="btn-cancel" onclick="closeDuplicateDetectionModal()">Cancel</button>
            <button type="button" class="btn-primary" onclick="proceedWithDuplicate()">Create Anyway</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Marketing Modal -->
    <div id="marketingModal" class="modal">
      <div class="marketing-mega-modal">
        <div class="marketing-modal-header">
          <h2>Marketing</h2>
          <button class="marketing-close-btn" onclick="closeMarketingModal()">&times;</button>
        </div>
        <div class="marketing-tabs">
          <button class="marketing-tab active" data-tab="campaigns" onclick="switchMarketingTab('campaigns')">Campaign Dashboard</button>
          <button class="marketing-tab" data-tab="datatools" onclick="switchMarketingTab('datatools')">Data Tools</button>
        </div>
        <div class="marketing-modal-body">
          <div id="marketingTabCampaigns" class="marketing-tab-panel active">
            <div id="campaignDashboard">
              <div class="campaign-dashboard-header">
                <div id="campaignStatsLoading" class="marketing-loading">Loading campaigns...</div>
                <button class="campaign-new-btn" onclick="createNewCampaign()">+ New Campaign</button>
              </div>
              <table id="campaignTable" class="campaign-table" style="display:none;">
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Name</th>
                    <th>Subject</th>
                    <th title="Delivered / Total Sent">Delivery Rate</th>
                    <th title="Unique Opens / Delivered">Open Rate</th>
                    <th title="Unique Clicks / Unique Opens">Engagement</th>
                    <th title="Unsubscribes / Delivered">Unsub Rate</th>
                  </tr>
                </thead>
                <tbody id="campaignTableBody"></tbody>
              </table>
            </div>
            <div id="campaignDetail" style="display:none;">
              <div class="campaign-detail-header">
                <button class="campaign-back-btn" onclick="showCampaignDashboard()">&larr; Back to Campaigns</button>
                <h3 id="campaignDetailTitle"></h3>
              </div>
              <div class="campaign-detail-filters" id="campaignDetailFilters">
                <button class="campaign-filter-btn active" data-filter="all" onclick="filterCampaignLogs('all')">All</button>
                <button class="campaign-filter-btn" data-filter="opened" onclick="filterCampaignLogs('opened')">Opened</button>
                <button class="campaign-filter-btn" data-filter="clicked" onclick="filterCampaignLogs('clicked')">Clicked</button>
                <button class="campaign-filter-btn" data-filter="bounced" onclick="filterCampaignLogs('bounced')">Bounced</button>
                <button class="campaign-filter-btn" data-filter="unsubscribed" onclick="filterCampaignLogs('unsubscribed')">Unsubscribed</button>
              </div>
              <div id="campaignDetailLoading" class="marketing-loading" style="display:none;">Loading recipients...</div>
              <table id="campaignDetailTable" class="campaign-table campaign-detail-table" style="display:none;">
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Status</th>
                    <th>Time</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody id="campaignDetailBody"></tbody>
              </table>
              <p id="campaignDetailEmpty" class="marketing-empty" style="display:none;">No recipients match this filter.</p>
            </div>
          </div>
          <div id="marketingTabDatatools" class="marketing-tab-panel">
            <div class="data-tools-grid">
              <div class="data-tools-col">
                <div class="marketing-section">
                  <h3>Export for Sending</h3>
                  <div id="marketingStats" class="marketing-stats">
                    <span style="color:#999;">Click to load contact data.</span>
                  </div>
                  <button id="marketingDownloadBtn" class="marketing-download-btn" onclick="downloadMarketingCsv()">Download Clean List (.csv)</button>
                  <p class="marketing-helper-text">Generates a deduplicated CSV for Mailmeteor. Handles shared emails (John &amp; Jane) automatically.</p>
                </div>
              </div>
              <div class="data-tools-col">
                <div class="marketing-section">
                  <h3>Import Campaign Results</h3>
                  <div class="marketing-import-form">
                    <label class="marketing-form-label" for="campaignSelect">Campaign</label>
                    <select id="campaignSelect" class="marketing-form-select" disabled>
                      <option value="">Loading campaigns...</option>
                    </select>
                    <label class="marketing-form-label" for="importFileInput">Mailmeteor Report (.csv)</label>
                    <input type="file" id="importFileInput" accept=".csv" class="marketing-form-file" disabled />
                    <div id="importFileInfo" class="marketing-file-info" style="display:none;"></div>
                    <button id="marketingImportBtn" class="marketing-import-btn" onclick="importCampaignResults()" disabled>Import Results</button>
                    <div id="importResultsStatus" class="marketing-import-status" style="display:none;"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Quill WYSIWYG Editor -->
    <link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>

    <script src="/api-bridge.js?v=100"></script>
    
    <!-- Foundation modules (load order matters!) -->
    <script src="/js/shared-state.js?v=100"></script>
    <script src="/js/shared-utils.js?v=100"></script>
    <script src="/js/modal-utils.js?v=100"></script>
    
    <!-- Feature modules -->
    <script src="/js/contacts-search.js?v=100"></script>
    <script src="/js/core.js?v=100"></script>
    <script src="/js/inline-editing.js?v=100"></script>
    <script src="/js/spouse.js?v=103"></script>
    <script src="/js/connections.js?v=106"></script>
    <script src="/js/notes.js?v=100"></script>
    <script src="/js/addresses.js?v=100"></script>
    <script src="/js/employment.js?v=105"></script>
    <script src="/js/appointments.js?v=100"></script>
    <script src="/js/opportunities.js?v=100"></script>
    <script src="/js/settings.js?v=100"></script>
    <script src="/js/quick-view.js?v=100"></script>
    <script src="/js/email.js?v=100"></script>
    <script src="/js/evidence.js?v=100"></script>
    <script src="/js/marketing-timeline.js?v=100"></script>
    <script src="/js/marketing.js?v=102"></script>
    <script src="/js/router.js?v=100"></script>
    
    <!-- Main app (contains all working code) -->
    <script src="/app.js?v=101"></script>

    <!-- Breakpoint Indicator (Development Helper) -->
    <div class="breakpoint-indicator"></div>
  </body>
</html>