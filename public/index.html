<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <title>Integrity - Stellaris FB</title>
    <link rel="icon" href="https://img1.wsimg.com/isteam/ip/2c5f94ee-4964-4e9b-9b9c-a55121f8611b/favicon/31eb51a1-8979-4194-bfa2-e4b30ee1178d/2437d5de-854d-40b2-86b2-fd879f3469f0.png/:/rs=w:64,h:64,m?v=3" type="image/png">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&family=Libre+Baskerville:wght@400;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="/styles.css?v=11">
  </head>
  <body>
    <div class="app-header">
      <div class="logo-container">
        <img class="logo-light" src="https://img1.wsimg.com/isteam/ip/2c5f94ee-4964-4e9b-9b9c-a55121f8611b/WEB_Stellaris_Primary%20Logo_Horizontal_Full%20Col.png/:/rs=w:400,h:130,cg:true,m/cr=w:400,h:130/qt=q:95" alt="Stellaris">
        <img class="logo-dark" src="https://img1.wsimg.com/isteam/ip/2c5f94ee-4964-4e9b-9b9c-a55121f8611b/WEB_Stellaris_Primary%20Logo_Horizontal_Reversed.png/:/rs=w:309,h:100,cg:true,m/cr=w:309,h:100/qt=q:26" alt="Stellaris">
      </div>
      <div class="header-title">INTEGRITY</div>
      <div class="user-indicator">
        <button class="shortcuts-help" onclick="showShortcutsHelp()" title="Keyboard shortcuts">?</button>
        <button class="settings-cog" onclick="openGlobalSettings()" title="Settings">⚙</button>
        <button class="theme-toggle" onclick="toggleDarkMode()" title="Toggle dark mode">◐</button>
        <span class="user-email" id="userEmail">Loading...</span>
      </div>
    </div>

    <div class="container">

      <div class="column form-section">
        <div class="header-row">
          <div style="display:flex; flex-direction:column; gap:2px;">
            <div style="display:flex; align-items:center; gap:12px;">
              <h2 id="formTitle">Contact</h2>
              <span id="formSubtitle" class="form-subtitle"></span>
              <span id="refreshBtn" class="refresh-icon" onclick="refreshCurrentContact()" title="Refresh Record">↻</span>
            </div>
          </div>
          <button type="button" class="new-btn" onclick="resetForm()">+ New Client</button>
        </div>

        <div id="duplicateWarningBox">
           <div style="display:flex; align-items:center;">
             <span class="warning-icon">⚠️</span> <span id="duplicateWarningText"></span>
           </div>
           <a class="hide-link" onclick="document.getElementById('duplicateWarningBox').style.display='none';">Hide</a>
        </div>

        <div id="auditSection"></div>
        <div id="formDivider" style="border-bottom:1px solid var(--color-border); margin-bottom:4px; display:none;"></div>

        <div id="emptyState">
           <img src="https://img1.wsimg.com/isteam/ip/2c5f94ee-4964-4e9b-9b9c-a55121f8611b/favicon/31eb51a1-8979-4194-bfa2-e4b30ee1178d/2437d5de-854d-40b2-86b2-fd879f3469f0.png/:/rs=w:128,h:128,m" style="height:64px; width:64px; margin-bottom:15px; opacity:0.8;">
           Search for a contact or click '+ New Client' to begin.
        </div>

        <div id="profileContent" style="display:none; flex:1; flex-direction:column;">
          <form id="contactForm" onsubmit="handleFormSubmit(this)" style="display:flex; flex-direction:column; flex:1;">
            <input type="hidden" name="recordId" id="recordId">
            <div class="profile-top">
              <div class="fields-header">
                <span id="editBtn" class="edit-icon" onclick="enableEditMode()" title="Edit Contact"><span class="edit-pencil">✎</span> Edit</span>
              </div>
              <div class="row" style="margin-bottom:10px;">
                <div class="field-group" style="flex:1;"><label>First Name</label><input type="text" name="firstName" id="firstName" class="locked" readonly required></div>
                <div class="field-group" style="flex:1;"><label>Middle Name</label><input type="text" name="middleName" id="middleName" class="locked" readonly></div>
                <div class="field-group" style="flex:1;"><label>Last Name</label><input type="text" name="lastName" id="lastName" class="locked" readonly required></div>
                <div class="field-group" style="flex:2;"><label>Email</label><input type="email" name="email1" id="email1" class="locked" readonly></div>
              </div>
              <div class="row">
                <div class="field-group" style="flex:1;"><label>Preferred</label><input type="text" name="preferredName" id="preferredName" class="locked" readonly></div>
                <div class="field-group" style="flex:1;"><label>Mobile</label><input type="text" name="mobilePhone" id="mobilePhone" class="locked" readonly></div>
                <div class="field-group" style="flex:3;"><label>Notes</label><textarea name="description" id="description" class="locked" readonly style="height:60px; resize:vertical;"></textarea></div>
              </div>
            </div>
            <div id="actionRow" class="save-row">
               <button type="button" id="cancelBtn" class="btn-cancel" onclick="cancelEditMode()" style="display:none;">Cancel</button>
               <button type="submit" id="submitBtn" style="width:auto; min-width:200px;">Update Contact</button>
            </div>
            <div id="status" style="text-align:center; margin-bottom:15px; min-height:18px;"></div>

            <div class="profile-bottom">
              <div class="profile-bottom-left">
                 <div id="spouseSection" style="margin-bottom:20px;">
                   <div class="spouse-header">
                      <span id="spouseStatusText">Single</span>
                      <span id="spouseEditLink" class="spouse-action-link" onclick="openSpouseModal()">Edit</span>
                   </div>
                   <ul id="spouseHistoryList" class="spouse-history-list"></ul>
                 </div>
                 <div id="futurePlaceholder" style="color:#CCC; text-align:center; font-size:12px; font-style:italic; padding:20px; border: 2px dashed #E0E0E0; border-radius:10px; margin-bottom:20px;">
                   Other Connections<br>Coming Soon
                 </div>
                 <div id="deleteSection" style="margin-top:auto; padding-top:20px; border-top:1px dashed #E0E0E0;">
                   <button type="button" class="btn-delete" onclick="confirmDeleteContact()">Delete Contact</button>
                 </div>
              </div>
              <div class="profile-bottom-right">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                  <h2 style="font-size:15px; margin-bottom:0;">Opportunities <span id="oppSortBtn" class="sort-icon" onclick="toggleOppSort()">⇅</span></h2>
                  <button type="button" class="quick-add-btn" onclick="quickAddOpportunity()" title="Add new opportunity">+ New</button>
                </div>
                <div id="oppLoading" style="display:none;">Loading...</div>
                <ul id="oppList" class="opp-list"></ul>
              </div>
            </div>
          </form>
        </div>
      </div>

      <div class="column list-section">
        <input type="text" id="searchInput" placeholder="Search Contacts..." onkeyup="handleSearch(event)">
        <div id="searchStatus" style="font-size:11px; color:#666; height:14px; margin-bottom:2px; text-align:right;"></div>
        <div id="loading">Loading directory...</div>
        <ul id="contactList"></ul>
      </div>

      <div id="oppDetailPanel" class="slide-panel">
        <div class="panel-header">
          <div style="display:flex; flex-direction:column; gap:5px;">
            <button id="panelBackBtn" class="back-btn" onclick="popHistory()">← Back</button>
            <h2 id="panelTitle" style="margin:0; border:none; font-size:16px;">Details</h2>
          </div>
          <button class="close-panel" onclick="closeOppPanel()">✕</button>
        </div>
        <div id="panelContent" class="panel-content">
          <div style="text-align:center; color:#999; margin-top:50px;">Loading...</div>
        </div>
      </div>

      <div id="oppComposer" class="slide-panel composer-panel">
        <div class="composer-header">
          <div class="composer-header-left">
            <h2 style="margin:0; font-size:18px; color:var(--color-midnight);">New Opportunity</h2>
            <p id="composerContactInfo" class="composer-contact-info"></p>
          </div>
          <button class="close-panel" onclick="closeOppComposer()">✕</button>
        </div>
        <div class="composer-body">
          <div class="composer-section">
            <div class="composer-section-title">Opportunity Details</div>
            <div class="composer-field">
              <label>Opportunity Name</label>
              <input type="text" id="composerOppName" placeholder="Enter opportunity name...">
            </div>
            <div class="composer-field">
              <label>Opportunity Type</label>
              <select id="composerOppType">
                <option value="Home Loans" selected>Home Loans</option>
                <option value="Commercial Loans">Commercial Loans</option>
                <option value="Deposit Bonds">Deposit Bonds</option>
                <option value="Insurance (General)">Insurance (General)</option>
                <option value="Insurance (Life)">Insurance (Life)</option>
                <option value="Personal Loans">Personal Loans</option>
                <option value="Asset Finance">Asset Finance</option>
                <option value="Tax Depreciation Schedule">Tax Depreciation Schedule</option>
              </select>
            </div>
          </div>
          <div class="composer-section">
            <div style="display:flex; flex-direction:column; gap:8px;">
              <div style="display:flex; align-items:center; gap:8px;">
                <span style="font-size:11px; color:#666; min-width:100px;">Primary Applicant:</span>
                <a id="composerPrimaryName" class="data-link" style="margin:0; padding:4px 8px; font-size:12px;"></a>
              </div>
              <div id="composerSpouseSection" style="display:none;">
                <label class="composer-checkbox-label">
                  <input type="checkbox" id="composerAddSpouse" onchange="updateComposerSpouseLabel()">
                  <span id="composerSpouseLabel"><span id="composerSpouseLabelPrefix">Also add </span><strong id="composerSpouseName"></strong><span id="composerSpouseLabelSuffix"> as Applicant</span></span>
                </label>
              </div>
            </div>
          </div>
          <div class="composer-section">
            <div class="composer-section-title" style="display:flex; justify-content:space-between; align-items:center;">
              <span>Import from Taco</span>
              <span style="font-size:11px; font-weight:normal; color:#999;">(optional)</span>
            </div>
            <div id="tacoImportArea">
              <textarea id="tacoRawInput" placeholder="Paste Taco data here..." rows="4" style="width:100%; font-size:13px; padding:10px; border:1px solid var(--color-border); border-radius:6px; resize:vertical; font-family:inherit;"></textarea>
              <button type="button" id="tacoParseBtnAction" onclick="parseTacoData()" style="margin-top:8px; padding:6px 14px; font-size:12px; background:var(--color-midnight); color:#FFF; border:none; border-radius:4px; cursor:pointer;">Parse</button>
            </div>
            <div id="tacoPreview" style="display:none; margin-top:10px;">
              <div style="font-size:12px; font-weight:500; margin-bottom:8px; color:var(--color-trail);">Parsed Fields:</div>
              <div id="tacoPreviewContent" style="font-size:12px; background:var(--color-salt); padding:10px; border-radius:6px; max-height:200px; overflow-y:auto;"></div>
              <button type="button" onclick="clearTacoImport()" style="margin-top:8px; padding:4px 10px; font-size:11px; background:transparent; color:#999; border:1px solid #CCC; border-radius:4px; cursor:pointer;">Clear Import</button>
            </div>
          </div>
        </div>
        <div class="composer-footer">
          <button type="button" class="composer-btn-cancel" onclick="closeOppComposer()">Cancel</button>
          <button type="button" class="composer-btn-create" onclick="submitFromComposer()">Create Opportunity</button>
        </div>
      </div>

      <div id="spouseModal" class="modal">
        <div class="modal-content">
          <div class="modal-sidebar">
             <img src="https://img1.wsimg.com/isteam/ip/2c5f94ee-4964-4e9b-9b9c-a55121f8611b/favicon/31eb51a1-8979-4194-bfa2-e4b30ee1178d/2437d5de-854d-40b2-86b2-fd879f3469f0.png/:/rs=w:64,h:64,m?v=3">
          </div>
          <div class="modal-body">

            <div id="connectForm" style="display:none; flex:1; display:flex; flex-direction:column;">
               <h3 style="margin-top:0; margin-bottom:15px; font-size:16px;">Connect Spouse</h3>
               <p style="font-size:13px; margin-bottom:10px; color:#666;">Search for the contact to connect:</p>
               <input type="text" id="spouseSearchInput" placeholder="Start typing name..." onkeyup="handleSpouseSearch(event)" onfocus="loadRecentContactsForModal()">
               <div id="spouseSearchResults" class="search-dropdown"></div>
               <div style="margin-top:auto; display:flex; gap:10px; justify-content:flex-end;">
                  <button type="button" class="btn-cancel" onclick="closeSpouseModal()">Cancel</button>
               </div>
            </div>

            <div id="confirmConnectForm" style="display:none; flex:1; flex-direction:column;">
               <h3 style="margin-top:0; margin-bottom:15px; font-size:16px;">Confirm Connection</h3>
               <p style="font-size:13px; color:#666; margin-bottom:20px;">Are you sure you want to set <strong id="targetSpouseName" style="color:var(--color-trail);"></strong> as the spouse?</p>
               <input type="hidden" id="targetSpouseId">
               <div style="margin-top:auto; display:flex; gap:10px; justify-content:flex-end;">
                  <button type="button" class="btn-cancel" onclick="backToSearch()">Back</button>
                  <button type="button" class="btn-confirm" onclick="executeSpouseChange('connect')">Confirm</button>
               </div>
            </div>

            <div id="disconnectForm" style="display:none; flex:1; flex-direction:column;">
               <h3 style="margin-top:0; margin-bottom:15px; font-size:16px;">Disconnect Spouse</h3>
               <p style="font-size:13px; color:#666; margin-bottom:20px;">Are you sure you want to disconnect <strong id="currentSpouseName" style="color:var(--color-trail);"></strong>?</p>
               <input type="hidden" id="currentSpouseId">
               <div style="margin-top:auto; display:flex; gap:10px; justify-content:flex-end;">
                  <button type="button" class="btn-cancel" onclick="closeSpouseModal()">Cancel</button>
                  <button type="button" class="btn-danger" onclick="executeSpouseChange('disconnect')">Disconnect</button>
               </div>
            </div>

          </div>
        </div>
      </div>

      <div id="deleteConfirmModal" class="modal">
        <div class="modal-content" style="max-width:400px;">
          <div class="modal-sidebar" style="background:#A00;">
            <span style="font-size:28px;">⚠</span>
          </div>
          <div class="modal-body">
            <h3 style="margin-top:0; margin-bottom:15px; font-size:16px;">Delete Contact</h3>
            <p id="deleteConfirmMessage" style="font-size:13px; color:#666; margin-bottom:20px;"></p>
            <div style="display:flex; gap:10px; justify-content:flex-end;">
              <button type="button" class="btn-cancel" onclick="closeDeleteConfirmModal()">Cancel</button>
              <button type="button" class="btn-danger" onclick="executeDeleteContact()">Delete</button>
            </div>
          </div>
        </div>
      </div>

      <div id="deleteOppConfirmModal" class="modal">
        <div class="modal-content" style="max-width:400px;">
          <div class="modal-sidebar" style="background:#A00;">
            <span style="font-size:28px;">⚠</span>
          </div>
          <div class="modal-body">
            <h3 style="margin-top:0; margin-bottom:15px; font-size:16px;">Delete Opportunity</h3>
            <p id="deleteOppConfirmMessage" style="font-size:13px; color:#666; margin-bottom:20px;"></p>
            <div style="display:flex; gap:10px; justify-content:flex-end;">
              <button type="button" class="btn-cancel" onclick="closeDeleteOppConfirmModal()">Cancel</button>
              <button type="button" class="btn-danger" onclick="executeDeleteOpportunity()">Delete</button>
            </div>
          </div>
        </div>
      </div>

      <div id="alertModal" class="modal">
        <div class="modal-content" style="width:550px; height:auto; max-height:80vh;">
          <div class="modal-sidebar" id="alertModalSidebar" style="width:60px; min-width:60px;">
            <span id="alertModalIcon" style="font-size:28px;">ℹ</span>
          </div>
          <div class="modal-body" style="overflow-y:auto;">
            <h3 id="alertModalTitle" style="margin-top:0; margin-bottom:15px; font-size:16px;">Notice</h3>
            <p id="alertModalMessage" style="font-size:13px; color:#666; margin-bottom:20px; white-space:pre-line;"></p>
            <div style="display:flex; gap:10px; justify-content:flex-end;">
              <button type="button" class="btn-cancel" onclick="closeAlertModal()">OK</button>
            </div>
          </div>
        </div>
      </div>

      <div id="shortcutsModal" class="modal">
        <div class="modal-content" style="max-width:320px;">
          <div class="modal-sidebar">
            <img src="https://img1.wsimg.com/isteam/ip/2c5f94ee-4964-4e9b-9b9c-a55121f8611b/favicon/31eb51a1-8979-4194-bfa2-e4b30ee1178d/2437d5de-854d-40b2-86b2-fd879f3469f0.png/:/rs=w:64,h:64,m?v=3">
          </div>
          <div class="modal-body">
            <h3 style="margin-top:0; margin-bottom:15px; font-size:16px;">Keyboard Shortcuts</h3>
            <div class="shortcuts-list">
              <div class="shortcut-row"><kbd>/</kbd><span>Focus search</span></div>
              <div class="shortcut-row"><kbd>N</kbd><span>New client</span></div>
              <div class="shortcut-row"><kbd>E</kbd><span>Edit contact</span></div>
              <div class="shortcut-row"><kbd>Esc</kbd><span>Close panel/modal</span></div>
              <div class="shortcut-row"><kbd>?</kbd><span>Show this help</span></div>
            </div>
            <div style="margin-top:20px; display:flex; justify-content:flex-end;">
              <button type="button" class="btn-cancel" onclick="closeShortcutsModal()">Close</button>
            </div>
          </div>
        </div>
      </div>

      <div id="emailComposer" class="email-composer-modal">
        <div class="email-composer-content">
          <div class="email-composer-header">
            <h2>Appointment Confirmation Email</h2>
            <div style="display:flex; align-items:center; gap:8px;">
              <button class="settings-cog-small" onclick="openEmailSettings()" title="Edit Links & Templates">⚙</button>
              <button class="close-panel" onclick="closeEmailComposer()">✕</button>
            </div>
          </div>
          <div class="email-composer-body">
            <div class="email-composer-settings">
              <div class="email-setting-group">
                <label>Appointment Type</label>
                <select id="emailApptType" onchange="updateEmailPreview()">
                  <option value="Office">Office</option>
                  <option value="Phone">Phone</option>
                  <option value="Video">Video</option>
                </select>
              </div>
              <div class="email-setting-group">
                <label>Client Type</label>
                <select id="emailClientType" onchange="updateEmailPreview()">
                  <option value="New">New Client</option>
                  <option value="Repeat">Repeat Client</option>
                </select>
              </div>
              <div class="email-setting-group">
                <label>Prep Handler</label>
                <select id="emailPrepHandler" onchange="updateEmailPreview()">
                  <option value="Shae">Shae (part-time)</option>
                  <option value="Team">Team (email Shae)</option>
                  <option value="OpenBanking">Open Banking (no docs)</option>
                </select>
              </div>
            </div>
            <div class="email-composer-fields">
              <div class="email-field-row">
                <label>To:</label>
                <input type="text" id="emailTo" readonly>
              </div>
              <div class="email-field-row">
                <label>Subject:</label>
                <input type="text" id="emailSubject" readonly>
              </div>
            </div>
            <div class="email-preview-container">
              <div class="email-preview-label" style="display:flex; justify-content:space-between; align-items:center;">
                <span>Email Body (editable)</span>
                <a href="#" onclick="event.preventDefault(); event.stopPropagation(); openCurrentTemplateEditor();" style="font-size:11px; color:var(--color-star); cursor:pointer;">Edit Template</a>
              </div>
              <div id="emailQuillContainer">
                <div id="emailQuillToolbar">
                  <span class="ql-formats">
                    <button class="ql-bold"></button>
                    <button class="ql-italic"></button>
                    <button class="ql-underline"></button>
                  </span>
                  <span class="ql-formats">
                    <button class="ql-link"></button>
                  </span>
                  <span class="ql-formats">
                    <button class="ql-list" value="ordered"></button>
                    <button class="ql-list" value="bullet"></button>
                  </span>
                  <span class="ql-formats">
                    <button class="ql-clean"></button>
                  </span>
                </div>
                <div id="emailPreviewBody" class="email-preview-body"></div>
              </div>
            </div>
          </div>
          <div class="email-composer-footer">
            <button type="button" class="btn-cancel" onclick="closeEmailComposer()">Cancel</button>
            <button type="button" class="btn-confirm" onclick="sendEmail()" id="emailSendBtn">Send</button>
          </div>
        </div>
      </div>

      <div id="emailSettingsModal" class="modal">
        <div class="modal-content" style="width:700px !important; height:auto !important; max-height:90vh;">
          <div class="modal-sidebar" style="background:var(--color-cedar); width:60px; min-width:60px;">
            <span style="font-size:24px;">⚙</span>
          </div>
          <div class="modal-body" style="overflow-y:auto; max-height:calc(90vh - 40px); flex:1;">
            <h3 style="margin-top:0; margin-bottom:15px; font-size:16px;">Settings</h3>
            <p style="font-size:12px; color:#666; margin-bottom:15px;">These settings are shared with the whole team. Changes you make here will update for everyone.</p>
            <div style="margin-bottom:15px; padding:12px; background:var(--color-sky); border-radius:6px; display:flex; justify-content:space-between; align-items:center;">
              <div>
                <div style="font-weight:600; font-size:13px;">Email Templates</div>
                <div style="font-size:11px; color:#666;">Manage email templates with conditional content</div>
              </div>
              <button type="button" onclick="closeEmailSettings(); openTemplateList();" style="padding:8px 16px; background:var(--color-star); color:white; border:none; border-radius:4px; cursor:pointer; font-size:12px; font-weight:500;">Manage Templates</button>
            </div>
            <div class="email-settings-form">
              <div class="setting-row">
                <label>Office Map Link</label>
                <input type="url" id="settingOfficeMap" placeholder="https://...">
              </div>
              <div class="setting-row">
                <label>Our Team Page</label>
                <input type="url" id="settingOurTeam" placeholder="https://...">
              </div>
              <div class="setting-row">
                <label>Fact Find Document</label>
                <input type="url" id="settingFactFind" placeholder="https://...">
              </div>
              <div class="setting-row">
                <label>myGov Link</label>
                <input type="url" id="settingMyGov" placeholder="https://...">
              </div>
              <div class="setting-row">
                <label>myGov Help Video</label>
                <input type="url" id="settingMyGovVideo" placeholder="https://...">
              </div>
              <div class="setting-row">
                <label>Income Statement Instructions</label>
                <input type="url" id="settingIncomeInstructions" placeholder="https://...">
              </div>
              <div style="border-top:1px solid var(--color-border); margin-top:12px; padding-top:12px;">
                <div class="setting-row">
                  <label>Your Email Signature</label>
                  <div style="background:var(--color-sky); padding:8px 12px; border-radius:4px; margin-bottom:8px; display:flex; justify-content:space-between; align-items:center;">
                    <div style="font-size:11px; color:#555;">
                      <span id="sigGenName">Loading...</span> · <span id="sigGenTitle"></span>
                    </div>
                    <div style="display:flex; gap:6px;">
                      <button type="button" onclick="regenerateSignature()" style="padding:4px 10px; background:var(--color-star); color:white; border:none; border-radius:4px; cursor:pointer; font-size:10px; font-weight:600; width:auto; margin:0;">Regenerate</button>
                      <button type="button" onclick="copySignatureForGmail()" style="padding:4px 10px; background:#555; color:white; border:none; border-radius:4px; cursor:pointer; font-size:10px; font-weight:500; width:auto; margin:0;">Copy for Gmail</button>
                      <button type="button" onclick="copySignatureForMercury()" style="padding:4px 10px; background:#555; color:white; border:none; border-radius:4px; cursor:pointer; font-size:10px; font-weight:500; width:auto; margin:0;">Copy for Mercury</button>
                    </div>
                  </div>
                  <div id="signaturePreviewContainer" style="background:#FFF; border:1px solid var(--color-border); border-radius:6px; padding:15px; min-height:80px; margin-bottom:8px; overflow:auto;"></div>
                  <span style="font-size:11px; color:#888; display:block;">Your signature is stored in Airtable and syncs across all your devices.</span>
                  <textarea id="settingSignature" style="display:none;"></textarea>
                </div>
              </div>
            </div>
            <div style="margin-top:20px; display:flex; justify-content:flex-end; gap:10px; padding-bottom:10px;">
              <button type="button" class="btn-cancel" onclick="closeEmailSettings()">Close</button>
              <button type="button" class="btn-confirm" onclick="saveEmailSettings()">Save</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Template Editor Modal -->
    <div id="templateEditorModal" class="modal-overlay" style="display:none;">
      <div class="modal-content template-editor-modal">
        <div class="modal-header">
          <h3 id="templateEditorTitle">Edit Template</h3>
          <button class="close-panel" onclick="closeTemplateEditor()">&times;</button>
        </div>
        <div class="template-editor-body">
          <div class="template-editor-main">
            <div class="template-editor-field">
              <label>Template Name</label>
              <input type="text" id="templateEditorName" placeholder="e.g., Appointment Confirmation">
            </div>
            <div class="template-editor-field template-subject-field">
              <label>Subject Line</label>
              <div id="templateEditorSubjectContainer">
                <div id="templateEditorSubject"></div>
              </div>
            </div>
            <div class="template-editor-field template-body-field">
              <label>Email Body</label>
              <div id="templateEditorQuillContainer">
                <div id="templateEditorToolbar">
                  <span class="ql-formats">
                    <button class="ql-bold"></button>
                    <button class="ql-italic"></button>
                    <button class="ql-underline"></button>
                  </span>
                  <span class="ql-formats">
                    <button class="ql-link"></button>
                  </span>
                  <span class="ql-formats">
                    <button class="ql-list" value="ordered"></button>
                    <button class="ql-list" value="bullet"></button>
                  </span>
                  <span class="ql-formats">
                    <button class="ql-clean"></button>
                  </span>
                </div>
                <div id="templateEditorBody"></div>
              </div>
            </div>
          </div>
          <div class="template-editor-sidebar">
            <div class="sidebar-section">
              <h4>Insert Variable</h4>
              <div id="variablePickerList" class="variable-picker-list"></div>
            </div>
            <div class="sidebar-section">
              <h4>Add Condition</h4>
              <div class="condition-builder">
                <select id="conditionVariable">
                  <option value="">Select variable...</option>
                  <option value="appointmentType">Appointment Type</option>
                  <option value="clientType">Client Type</option>
                  <option value="prepHandler">Prep Handler</option>
                </select>
                <div id="conditionOptionsContainer" style="display:none;">
                  <div class="condition-options" id="conditionOptions"></div>
                  <button type="button" class="btn-insert-condition" onclick="insertConditionBlock()">Insert Condition Block</button>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn-cancel" onclick="closeTemplateEditor()">Cancel</button>
          <button type="button" class="btn-confirm" id="templateEditorSaveBtn" onclick="saveTemplate()">Save Template</button>
        </div>
      </div>
    </div>

    <!-- Template List Modal (Central Hub) -->
    <div id="templateListModal" class="modal-overlay" style="display:none;">
      <div class="modal-content" style="max-width:700px;">
        <div class="modal-header">
          <h3>Email Templates</h3>
          <button class="close-panel" onclick="closeTemplateList()">&times;</button>
        </div>
        <div class="modal-body" style="padding:20px;">
          <p style="font-size:13px; color:#666; margin-bottom:15px;">Manage email templates used across the system. Changes apply to everyone.</p>
          <div id="templateListContainer"></div>
          <div style="margin-top:15px;">
            <button type="button" class="btn-confirm" onclick="createNewTemplate()">+ New Template</button>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn-cancel" onclick="closeTemplateList()">Close</button>
        </div>
      </div>
    </div>

    
    <div style="position:fixed; bottom:5px; right:10px; font-size:10px; color:#AAA; z-index:1000; font-family:sans-serif;">
       User: <span id="debugUser">Loading...</span> | v4.3 (Signature)
    </div>

    <!-- Appointment Form Modal -->
    <div id="appointmentFormModal" class="modal-overlay">
      <div class="modal-content" style="max-width:600px;">
        <div class="modal-header">
          <h3 id="appointmentFormTitle">New Appointment</h3>
          <button class="close-panel" onclick="closeAppointmentForm()">&times;</button>
        </div>
        <div class="modal-body" style="padding:20px;">
          <div class="form-row">
            <div class="field-group" style="flex:1;">
              <label>Appointment Time</label>
              <input type="datetime-local" id="apptFormTime">
            </div>
            <div class="field-group" style="flex:1;">
              <label>Status</label>
              <select id="apptFormStatus">
                <option value="">Not Set</option>
                <option value="Scheduled">Scheduled</option>
                <option value="Completed">Completed</option>
                <option value="Cancelled">Cancelled</option>
                <option value="No Show">No Show</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="field-group" style="flex:1;">
              <label>Type of Appointment</label>
              <select id="apptFormType" onchange="updateAppointmentFormVisibility()">
                <option value="Office">Office</option>
                <option value="Phone">Phone</option>
                <option value="Video">Video</option>
              </select>
            </div>
            <div class="field-group" style="flex:1;">
              <label>How Booked</label>
              <select id="apptFormHowBooked" onchange="updateAppointmentFormVisibility()">
                <option value="Calendly">Calendly</option>
                <option value="Email">Email</option>
                <option value="Phone">Phone</option>
                <option value="Podium">Podium</option>
                <option value="Other">Other</option>
              </select>
            </div>
          </div>
          <div class="form-row" id="apptFormHowBookedOtherRow" style="display:none;">
            <div class="field-group" style="flex:1;">
              <label>How Booked (Other)</label>
              <input type="text" id="apptFormHowBookedOther" placeholder="Specify how booked">
            </div>
          </div>
          <div class="form-row" id="apptFormPhoneRow" style="display:none;">
            <div class="field-group" style="flex:1;">
              <label>Phone Number</label>
              <input type="text" id="apptFormPhone" placeholder="Client phone number">
            </div>
          </div>
          <div class="form-row" id="apptFormMeetRow" style="display:none;">
            <div class="field-group" style="flex:1;">
              <label>Video Meet URL</label>
              <input type="text" id="apptFormMeetUrl" placeholder="meet.google.com/xxx-xxxx-xxx">
            </div>
          </div>
          <div class="form-row">
            <div class="field-group" style="flex:1;">
              <label style="display:flex; align-items:center; gap:8px;">
                <input type="checkbox" id="apptFormNeedEvidence" style="width:auto; margin:0;">
                Need Evidence in Advance
              </label>
            </div>
            <div class="field-group" style="flex:1;">
              <label style="display:flex; align-items:center; gap:8px;">
                <input type="checkbox" id="apptFormNeedReminder" style="width:auto; margin:0;">
                Need Appointment Reminder
              </label>
            </div>
          </div>
          <div class="form-row">
            <div class="field-group" style="flex:1;">
              <label>Notes</label>
              <textarea id="apptFormNotes" rows="3" placeholder="Additional notes..."></textarea>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn-cancel" onclick="closeAppointmentForm()">Cancel</button>
          <button type="button" id="apptFormSaveBtn" class="btn-confirm" onclick="saveAppointment()">Save</button>
        </div>
      </div>
    </div>

    <!-- Quill WYSIWYG Editor -->
    <link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>

    <script src="/api-bridge.js?v=11"></script>
    <script src="/app.js?v=11"></script>
  </body>
</html>